<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Nautilus - Payload Launcher</title>
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #12121a;
      --surface2: #1a1a25;
      --border: #2a2a3a;
      --accent: #00d4aa;
      --accent2: #00b894;
      --danger: #ff4757;
      --text: #e8e8e8;
      --text2: #888;
      --glow: 0 0 20px rgba(0, 212, 170, 0.3)
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow: hidden
    }

    .header {
      background: linear-gradient(135deg, var(--surface) 0%, var(--surface2) 100%);
      padding: 12px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px
    }

    .logo img {
      width: 36px;
      height: 36px;
      border-radius: 8px
    }

    .logo h1 {
      font-size: 1.4em;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), #00f5d4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85em;
      color: var(--text2)
    }

    .status::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: var(--glow);
      animation: pulse 2s infinite
    }

    .status.error::before {
      background: var(--danger)
    }

    .status.running::before {
      background: #ffd93d;
      animation: blink 0.5s infinite
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0.5
      }
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0.3
      }
    }

    .container {
      display: flex;
      height: calc(100vh - 98px)
    }

    .sidebar {
      width: 280px;
      min-width: 200px;
      background: var(--surface);
      overflow-y: auto;
      border-right: none;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent
    }

    .resize-handle {
      width: 5px;
      background: var(--border);
      cursor: col-resize;
      flex-shrink: 0;
      transition: background 0.2s
    }

    .resize-handle:hover,
    .resize-handle.dragging {
      background: var(--accent)
    }

    .resize-handle-v {
      height: 5px;
      width: 100%;
      background: var(--border);
      cursor: row-resize;
      flex-shrink: 0;
      transition: background 0.2s
    }

    .resize-handle-v:hover,
    .resize-handle-v.dragging {
      background: var(--accent)
    }

    body.resizing {
      cursor: col-resize;
      user-select: none
    }

    body.resizing-v {
      cursor: row-resize;
      user-select: none
    }

    .sidebar::-webkit-scrollbar {
      width: 6px
    }

    .sidebar::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: row;
      overflow: hidden;
      background: var(--bg)
    }

    .main-left {
      width: 350px;
      min-width: 250px;
      display: flex;
      flex-direction: column;
      border-right: none;
      flex-shrink: 0
    }

    .main-right {
      flex: 1;
      display: flex;
      flex-direction: row;
      overflow: hidden
    }

    .console-panel {
      width: 50%;
      min-width: 200px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex-shrink: 0
    }

    .console-panel:first-child {
      border-right: none
    }

    .shell-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden
    }

    .shell-panel .console-header {
      background: var(--surface)
    }

    .shell-panel #shellTerminal {
      flex: 1;
      background: #000;
      overflow: hidden
    }

    .shell-panel #shellTerminal .xterm {
      height: 100%
    }

    .shell-panel .shell-status {
      font-size: 0.75em;
      padding: 2px 8px;
      border-radius: 4px;
      margin-left: 8px
    }

    .shell-panel .shell-status.connected {
      color: var(--accent)
    }

    .shell-panel .shell-status.disconnected {
      color: var(--danger)
    }

    .search {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border)
    }

    .search input {
      width: 100%;
      padding: 10px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.9em;
      transition: all 0.2s
    }

    .search input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: var(--glow)
    }

    .search input::placeholder {
      color: var(--text2)
    }

    .category {
      border-bottom: 1px solid var(--border)
    }

    .cat-header {
      padding: 12px 16px;
      background: var(--surface2);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.8em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text2)
    }

    .cat-header:hover {
      background: var(--border);
      color: var(--text)
    }

    .cat-header .count {
      background: var(--bg);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.8em;
      font-weight: 500
    }

    .cat-header .arrow {
      transition: transform 0.3s ease;
      font-size: 0.7em
    }

    .cat-header.open .arrow {
      transform: rotate(90deg)
    }

    .cat-header.open {
      color: var(--accent)
    }

    .payloads {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: var(--bg)
    }

    .payloads.open {
      max-height: 50vh;
      overflow-y: auto
    }

    .payload {
      padding: 10px 16px 10px 20px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: all 0.15s;
      position: relative
    }

    .payload::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--accent);
      transform: scaleY(0);
      transition: transform 0.2s
    }

    .payload:hover {
      background: var(--surface2)
    }

    .payload:hover::before {
      transform: scaleY(1)
    }

    .payload.active {
      background: var(--surface2)
    }

    .payload.active::before {
      transform: scaleY(1)
    }

    .payload.disabled {
      opacity: 0.5
    }

    .payload.disabled::before {
      background: var(--text2)
    }

    .disabled-badge {
      display: inline-block;
      font-size: 0.65em;
      padding: 1px 5px;
      margin-left: 8px;
      background: var(--text2);
      color: var(--bg);
      border-radius: 3px;
      font-weight: 600;
      vertical-align: middle
    }

    .payload .name {
      color: var(--text);
      font-weight: 500;
      font-size: 0.85em;
      margin-bottom: 2px
    }

    .payload .desc {
      color: var(--text2);
      font-size: 0.75em;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden
    }

    .payload .source-badge {
      display: inline-block;
      font-size: 0.65em;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
      font-weight: 600;
      text-transform: uppercase
    }

    .payload .source-badge.local {
      background: rgba(0, 212, 170, 0.15);
      color: var(--accent)
    }

    .payload .source-badge.merged {
      background: rgba(255, 193, 7, 0.15);
      color: #ffc107
    }

    .fav-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.5;
      transition: all 0.2s
    }

    .fav-btn:hover {
      opacity: 1;
      transform: scale(1.1)
    }

    .fav-btn svg {
      width: 20px;
      height: 20px;
      fill: var(--text2)
    }

    .fav-btn.active svg {
      fill: #f1c40f
    }

    .fav-btn.active {
      opacity: 1
    }

    .payload.fav-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding-left: 8px
    }

    .payload.fav-row .fav-info {
      flex: 1;
      cursor: pointer
    }

    .detail {
      padding: 20px;
      background: linear-gradient(180deg, var(--surface) 0%, var(--bg) 100%);
      flex: 1;
      overflow-y: auto
    }

    .detail h2 {
      color: var(--text);
      margin-bottom: 8px;
      font-size: 1.2em;
      font-weight: 600
    }

    .detail .meta {
      display: flex;
      gap: 16px;
      color: var(--text2);
      font-size: 0.8em;
      margin-bottom: 12px;
      flex-wrap: wrap
    }

    .detail .meta span {
      display: flex;
      align-items: center;
      gap: 5px
    }

    .detail .meta svg {
      width: 14px;
      height: 14px;
      fill: var(--text2)
    }

    .detail .description {
      color: var(--text2);
      line-height: 1.5;
      margin-bottom: 16px;
      font-size: 0.9em
    }

    .actions {
      display: flex;
      flex-direction: column
    }

    .btn {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #000;
      border: none;
      padding: 10px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 600;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: center
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--glow)
    }

    .btn:active {
      transform: translateY(0)
    }

    .btn.stop {
      background: linear-gradient(135deg, var(--danger), #ff6b81)
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-bottom: 8px
    }

    .btn-row .btn {
      flex: 1 1 0;
      min-width: 0;
      white-space: nowrap
    }

    .btn-half {
      width: calc(50% - 5px)
    }

    .btn.secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 16px
    }

    .btn.secondary:hover {
      border-color: var(--accent);
      color: var(--accent)
    }

    .console-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden
    }

    .console-header {
      padding: 10px 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8em;
      color: var(--text2)
    }

    .console-header button {
      background: none;
      border: 1px solid var(--border);
      color: var(--text2);
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85em
    }

    .console-header button:hover {
      border-color: var(--accent);
      color: var(--accent)
    }

    .console {
      flex: 1;
      background: #050508;
      overflow-y: auto;
      padding: 16px;
      font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 0.8em;
      line-height: 1.5;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent
    }

    .console::-webkit-scrollbar {
      width: 6px
    }

    .console::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px
    }

    .console .line {
      margin: 1px 0;
      padding: 1px 0;
      white-space: pre-wrap;
      word-break: break-word
    }

    .console .cyan,
    .console .green {
      color: var(--accent)
    }

    .console .yellow {
      color: #ffd93d
    }

    .console .red {
      color: var(--danger)
    }

    .console .magenta {
      color: #ff6b9d
    }

    .console .blue {
      color: #54a0ff
    }

    .source-viewer {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #050508;
      overflow: auto;
      padding: 0;
      font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 0.75em;
      line-height: 1.6;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
      z-index: 5
    }

    .source-viewer::-webkit-scrollbar {
      width: 6px
    }

    .source-viewer::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px
    }

    .source-viewer table {
      border-collapse: collapse;
      width: 100%
    }

    .source-viewer .line-num {
      padding: 0 12px 0 8px;
      text-align: right;
      color: #555;
      user-select: none;
      border-right: 1px solid #222;
      background: #0a0a0f;
      position: sticky;
      left: 0;
      min-width: 40px
    }

    .source-viewer .line-code {
      padding: 0 12px;
      white-space: pre;
      color: #c9d1d9
    }

    .source-viewer tr:hover .line-code {
      background: #111118
    }

    .source-viewer tr:hover .line-num {
      background: #0f0f15;
      color: #888
    }

    .source-viewer .sh-comment {
      color: #6a737d;
      font-style: italic
    }

    .source-viewer .sh-string {
      color: #a5d6ff
    }

    .source-viewer .sh-keyword {
      color: #ff7b72
    }

    .source-viewer .sh-variable {
      color: #79c0ff
    }

    .source-viewer .sh-function {
      color: #d2a8ff
    }

    .console-wrap {
      position: relative
    }

    .empty {
      padding: 40px 30px;
      text-align: center;
      color: var(--text2)
    }

    .empty svg {
      width: 48px;
      height: 48px;
      fill: var(--border);
      margin-bottom: 12px
    }

    .empty h3 {
      color: var(--text);
      margin-bottom: 6px;
      font-weight: 500;
      font-size: 1em
    }

    .empty p {
      font-size: 0.85em
    }

    @media(max-width:1100px) {
      .main {
        flex-direction: column
      }

      .main-left {
        max-width: none;
        border-right: none;
        border-bottom: 1px solid var(--border);
        max-height: 200px
      }

      .main-right {
        flex: 1;
        flex-direction: column
      }

      .console-panel:first-child {
        border-right: none;
        border-bottom: 1px solid var(--border)
      }
    }

    @media(max-width:700px) {
      .container {
        flex-direction: column
      }

      .sidebar {
        width: 100%;
        max-height: 35vh;
        border-right: none;
        border-bottom: 1px solid var(--border)
      }

      .main {
        flex: 1
      }

      .main-left {
        max-height: 150px
      }

      .main-right {
        flex-direction: column
      }
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
      transition: backdrop-filter 0.15s, background 0.15s
    }

    .modal-overlay.show {
      display: flex
    }

    .modal-overlay.peek {
      backdrop-filter: none;
      background: rgba(0, 0, 0, 0.3)
    }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      min-width: 300px;
      max-width: 420px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      transition: opacity 0.15s
    }

    .modal-overlay.peek .modal {
      opacity: 0.5
    }

    .modal-peek-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      opacity: 0.5;
      transition: opacity 0.15s
    }

    .modal-peek-btn:hover {
      opacity: 1
    }

    .modal-peek-btn svg {
      width: 18px;
      height: 18px;
      fill: var(--text2)
    }

    .modal {
      position: relative
    }

    .modal-title {
      font-size: 1.1em;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 10px
    }

    .modal-message {
      color: var(--text);
      line-height: 1.5;
      margin-bottom: 16px;
      font-size: 0.95em
    }

    .modal-input {
      width: 100%;
      padding: 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 1em;
      margin-bottom: 16px
    }

    .modal-input:focus {
      outline: none;
      border-color: var(--accent)
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center
    }

    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000
    }

    .login-overlay.hidden {
      display: none
    }

    .login-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      width: 320px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5)
    }

    .login-box img {
      width: 64px;
      height: 64px;
      border-radius: 12px;
      margin-bottom: 16px
    }

    .login-box h2 {
      font-size: 1.4em;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--accent), #00f5d4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent
    }

    .login-box p {
      color: var(--text2);
      font-size: 0.85em;
      margin-bottom: 20px
    }

    .login-box input {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 1em;
      margin-bottom: 12px
    }

    .login-box input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: var(--glow)
    }

    .login-box .btn {
      width: 100%;
      justify-content: center
    }

    .login-error {
      color: var(--danger);
      font-size: 0.85em;
      margin-bottom: 12px;
      display: none
    }

    .login-error.show {
      display: block
    }

    .tabs-container {
      background: var(--surface2)
    }

    .tabs-row {
      display: flex;
      border-bottom: 1px solid var(--border)
    }

    .tabs-row.resource-row {
      background: var(--surface);
      border-bottom: 2px solid var(--border)
    }

    .tabs-row.resource-row .tab {
      font-size: 0.7em;
      padding: 8px 6px
    }

    .tabs-row.favourites-row {
      border-bottom: none
    }

    .tab {
      flex: 1;
      padding: 10px 8px;
      text-align: center;
      font-size: 0.75em;
      font-weight: 600;
      color: var(--text2);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px
    }

    .tab:hover {
      color: var(--text);
      background: rgba(255, 255, 255, 0.03)
    }

    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
      background: rgba(0, 212, 170, 0.05)
    }

    .tab.favourites {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px
    }

    .tab.favourites svg {
      width: 14px;
      height: 14px;
      fill: currentColor
    }

    .tab.favourites.active svg {
      fill: var(--accent)
    }

    .tab-content {
      display: none
    }

    .tab-content.active {
      display: block
    }

    .github-loading {
      padding: 40px 20px;
      text-align: center;
      color: var(--text2)
    }

    .github-loading img {
      width: 100px;
      height: 100px;
      animation: spin 2s linear infinite;
      margin: 0 auto 16px;
      display: block
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    .pr-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.15s
    }

    .pr-item:hover {
      background: var(--surface2)
    }

    .pr-item .pr-title {
      font-size: 0.85em;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 4px
    }

    .pr-item .pr-labels {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 4px
    }

    .pr-item .pr-label {
      font-size: 0.7em;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 500;
      white-space: nowrap
    }

    .pr-item .pr-meta {
      font-size: 0.75em;
      color: var(--text2)
    }

    .pr-item .pr-number {
      color: var(--accent);
      font-weight: 600
    }

    .search-row {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border)
    }

    .search-row input {
      flex: 1;
      padding: 10px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.9em;
      transition: all 0.2s
    }

    .search-row input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: var(--glow)
    }

    .search-row input::placeholder {
      color: var(--text2)
    }

    .refresh-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text2);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85em;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px
    }

    .refresh-btn:hover {
      border-color: var(--accent);
      color: var(--accent)
    }

    .refresh-btn.loading {
      pointer-events: none;
      opacity: 0.6
    }

    .refresh-btn svg {
      width: 14px;
      height: 14px;
      fill: currentColor
    }

    .cache-info {
      font-size: 0.7em;
      color: var(--text2);
      padding: 4px 16px;
      background: var(--surface2);
      border-bottom: 1px solid var(--border)
    }

    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(4px)
    }

    .spinner-overlay.show {
      display: flex
    }

    .spinner-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px 48px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      position: relative;
      min-width: 200px
    }

    .spinner-box img {
      width: 100px;
      height: 100px;
      animation: spin 2s linear infinite;
      margin-bottom: 16px
    }

    .spinner-box .spinner-text {
      color: var(--text);
      font-size: 1em;
      font-weight: 500
    }

    .spinner-kill {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text2);
      transition: all 0.15s
    }

    .spinner-kill:hover {
      background: #e74c3c;
      border-color: #e74c3c;
      color: #fff
    }

    .spinner-kill svg {
      width: 14px;
      height: 14px;
      fill: currentColor
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    .wifi-bar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 8px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.85em
    }

    .wifi-bar.collapsed .wifi-details {
      display: none
    }

    .wifi-bar .wifi-icon {
      width: 20px;
      height: 20px;
      fill: var(--text2);
      flex-shrink: 0
    }

    .wifi-bar .wifi-icon.connected {
      fill: var(--accent)
    }

    .wifi-bar .wifi-icon.disconnected {
      fill: var(--text2)
    }

    .wifi-bar .wifi-status {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px
    }

    .wifi-bar .wifi-ssid {
      color: var(--text);
      font-weight: 500;
      cursor: pointer
    }

    .wifi-bar .wifi-ssid.clickable:hover {
      color: var(--accent)
    }

    .wifi-bar .wifi-signal {
      color: var(--text2);
      font-size: 0.9em
    }

    .wifi-bar .wifi-details {
      display: flex;
      align-items: center;
      gap: 12px
    }

    .wifi-bar .wifi-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 4px
    }

    .wifi-bar .wifi-btn:hover {
      border-color: var(--accent);
      color: var(--accent)
    }

    .wifi-bar .wifi-btn.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #000;
      border: none
    }

    .wifi-bar .wifi-btn.primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--glow)
    }

    .wifi-bar .wifi-btn.danger {
      border-color: #e74c3c;
      color: #e74c3c
    }

    .wifi-bar .wifi-btn.danger:hover {
      background: #e74c3c;
      color: #fff
    }

    .wifi-bar .wifi-btn svg {
      width: 14px;
      height: 14px;
      fill: currentColor
    }

    .wifi-bar .wifi-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text2)
    }

    .wifi-bar .toggle-switch {
      width: 36px;
      height: 20px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      position: relative;
      transition: all 0.2s
    }

    .wifi-bar .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 14px;
      height: 14px;
      background: var(--text2);
      border-radius: 50%;
      transition: all 0.2s
    }

    .wifi-bar .toggle-switch.on {
      background: var(--accent);
      border-color: var(--accent)
    }

    .wifi-bar .toggle-switch.on::after {
      left: 18px;
      background: #000
    }

    .wifi-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2500;
      backdrop-filter: blur(4px)
    }

    .wifi-modal.show {
      display: flex
    }

    .wifi-modal .wifi-modal-content {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 90%;
      max-width: 420px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4)
    }

    .wifi-modal .wifi-modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between
    }

    .wifi-modal .wifi-modal-header h3 {
      margin: 0;
      font-size: 1.1em;
      color: var(--text)
    }

    .wifi-modal .wifi-modal-close {
      background: none;
      border: none;
      color: var(--text2);
      cursor: pointer;
      padding: 4px;
      display: flex
    }

    .wifi-modal .wifi-modal-close:hover {
      color: var(--text)
    }

    .wifi-modal .wifi-modal-close svg {
      width: 20px;
      height: 20px;
      fill: currentColor
    }

    .wifi-modal .wifi-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      min-height: 150px;
      max-height: 50vh
    }

    .wifi-modal .wifi-scan-status {
      padding: 16px 20px;
      text-align: center;
      color: var(--text2);
      font-size: 0.9em
    }

    .wifi-modal .wifi-scan-status .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 8px
    }

    .wifi-modal #wifiNetworkList {
      max-height: 100%;
      overflow-y: auto
    }

    .wifi-modal .wifi-network {
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: background 0.15s
    }

    .wifi-modal .wifi-network:hover {
      background: var(--surface2)
    }

    .wifi-modal .wifi-network.selected {
      background: rgba(0, 255, 136, 0.1);
      border-left: 3px solid var(--accent)
    }

    .wifi-modal .wifi-network .wifi-net-info {
      flex: 1;
      min-width: 0
    }

    .wifi-modal .wifi-network .wifi-net-ssid {
      color: var(--text);
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    .wifi-modal .wifi-network .wifi-net-details {
      color: var(--text2);
      font-size: 0.8em;
      display: flex;
      gap: 8px;
      margin-top: 2px
    }

    .wifi-modal .wifi-network .wifi-net-lock {
      width: 16px;
      height: 16px;
      fill: var(--text2);
      flex-shrink: 0
    }

    .wifi-modal .wifi-network .wifi-net-signal {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 18px;
      flex-shrink: 0
    }

    .wifi-modal .wifi-network .wifi-net-signal span {
      width: 4px;
      border-radius: 1px
    }

    .wifi-modal .wifi-password-section {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      background: var(--surface2)
    }

    .wifi-modal .wifi-password-section label {
      display: block;
      color: var(--text2);
      font-size: 0.85em;
      margin-bottom: 6px
    }

    .wifi-modal .wifi-password-section .password-input-wrap {
      display: flex;
      gap: 8px
    }

    .wifi-modal .wifi-password-section input {
      flex: 1;
      padding: 10px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.9em
    }

    .wifi-modal .wifi-password-section input:focus {
      outline: none;
      border-color: var(--accent)
    }

    .wifi-modal .wifi-password-section .show-pass-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text2);
      padding: 0 12px;
      border-radius: 8px;
      cursor: pointer
    }

    .wifi-modal .wifi-password-section .show-pass-btn:hover {
      color: var(--text)
    }

    .wifi-modal .wifi-modal-footer {
      padding: 12px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 8px
    }

    .wifi-modal .wifi-modal-footer .wifi-btn {
      padding: 10px 18px;
      border-radius: 8px;
      font-weight: 500;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.15s;
      border: none
    }

    .wifi-modal .wifi-modal-footer .wifi-btn.secondary {
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border)
    }

    .wifi-modal .wifi-modal-footer .wifi-btn.secondary:hover {
      background: var(--surface);
      border-color: var(--text2)
    }

    .wifi-modal .wifi-modal-footer .wifi-btn.primary {
      background: var(--accent);
      color: #000;
      min-width: 120px
    }

    .wifi-modal .wifi-modal-footer .wifi-btn.primary:hover {
      filter: brightness(1.1)
    }

    .wifi-modal .wifi-modal-footer .wifi-btn.primary:disabled {
      opacity: 0.5;
      cursor: not-allowed
    }

    .button-panel {
      display: none;
      background: linear-gradient(180deg, var(--surface) 0%, var(--surface2) 100%);
      border-top: 1px solid var(--border);
      padding: 16px;
      justify-content: center;
      align-items: center;
      gap: 24px
    }

    .button-panel.show {
      display: flex
    }

    .button-panel .dpad {
      display: grid;
      grid-template-columns: 40px 40px 40px;
      grid-template-rows: 40px 40px 40px;
      gap: 4px
    }

    .button-panel .dpad-btn {
      width: 40px;
      height: 40px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
      font-size: 1.2em;
      transition: all 0.15s;
      user-select: none
    }

    .button-panel .dpad-btn:hover {
      background: var(--border);
      border-color: var(--accent)
    }

    .button-panel .dpad-btn:active {
      background: var(--accent);
      color: #000;
      transform: scale(0.95)
    }

    .button-panel .dpad-btn.up {
      grid-column: 2;
      grid-row: 1
    }

    .button-panel .dpad-btn.left {
      grid-column: 1;
      grid-row: 2
    }

    .button-panel .dpad-btn.center {
      grid-column: 2;
      grid-row: 2;
      background: var(--bg);
      border-radius: 50%;
      cursor: default
    }

    .button-panel .dpad-btn.center:hover {
      background: var(--bg);
      border-color: var(--border)
    }

    .button-panel .dpad-btn.right {
      grid-column: 3;
      grid-row: 2
    }

    .button-panel .dpad-btn.down {
      grid-column: 2;
      grid-row: 3
    }

    .button-panel .ab-btns {
      display: flex;
      flex-direction: column;
      gap: 8px
    }

    .button-panel .ab-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid;
      cursor: pointer;
      font-weight: 700;
      font-size: 1.1em;
      transition: all 0.15s;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center
    }

    .button-panel .ab-btn.btn-a {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      border-color: #27ae60;
      color: #fff
    }

    .button-panel .ab-btn.btn-a:hover {
      box-shadow: 0 0 12px rgba(46, 204, 113, 0.5)
    }

    .button-panel .ab-btn.btn-a:active {
      transform: scale(0.95);
      filter: brightness(0.9)
    }

    .button-panel .ab-btn.btn-b {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      border-color: #c0392b;
      color: #fff
    }

    .button-panel .ab-btn.btn-b:hover {
      box-shadow: 0 0 12px rgba(231, 76, 60, 0.5)
    }

    .button-panel .ab-btn.btn-b:active {
      transform: scale(0.95);
      filter: brightness(0.9)
    }

    .button-panel .waiting-hint {
      color: var(--text2);
      font-size: 0.8em;
      text-align: center;
      margin-left: 16px
    }

    .button-panel .waiting-hint .expected {
      color: var(--accent);
      font-weight: 600
    }

    .settings-btn {
      background: none;
      border: none;
      color: var(--text2);
      cursor: pointer;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s
    }

    .settings-btn:hover {
      color: var(--accent);
      background: var(--surface2)
    }

    .settings-btn svg {
      width: 20px;
      height: 20px;
      fill: currentColor
    }

    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2500;
      backdrop-filter: blur(4px)
    }

    .settings-modal.show {
      display: flex
    }

    .settings-modal-content {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 90%;
      max-width: 480px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4)
    }

    .settings-modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between
    }

    .settings-modal-header h3 {
      margin: 0;
      font-size: 1.1em;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 10px
    }

    .settings-modal-header h3 svg {
      width: 22px;
      height: 22px;
      fill: var(--accent)
    }

    .settings-modal-close {
      background: none;
      border: none;
      color: var(--text2);
      cursor: pointer;
      padding: 4px;
      display: flex
    }

    .settings-modal-close:hover {
      color: var(--text)
    }

    .settings-modal-close svg {
      width: 20px;
      height: 20px;
      fill: currentColor
    }

    .settings-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px
    }

    .settings-section {
      margin-bottom: 24px
    }

    .settings-section:last-child {
      margin-bottom: 0
    }

    .settings-section-title {
      font-size: 0.75em;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px
    }

    .settings-section-title svg {
      width: 14px;
      height: 14px;
      fill: currentColor
    }

    .settings-item {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 10px;
      overflow: hidden
    }

    .settings-item:last-child {
      margin-bottom: 0
    }

    .settings-item-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 14px 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border)
    }

    .settings-item-header-info {
      flex: 1
    }

    .settings-item-header-label {
      color: var(--text);
      font-weight: 600;
      font-size: 0.9em
    }

    .settings-item-body {
      padding: 16px
    }

    .settings-item-body.disabled {
      opacity: 0.4;
      pointer-events: none
    }

    .settings-item-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 16px
    }

    .settings-item-info {
      flex: 1
    }

    .settings-item-label {
      color: var(--text);
      font-weight: 500;
      font-size: 0.9em;
      margin-bottom: 2px
    }

    .settings-item-desc {
      color: var(--text2);
      font-size: 0.8em;
      line-height: 1.4
    }

    .settings-toggle {
      position: relative;
      width: 44px;
      height: 24px;
      background: var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0
    }

    .settings-toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 18px;
      height: 18px;
      background: var(--text2);
      border-radius: 50%;
      transition: all 0.2s
    }

    .settings-toggle.on {
      background: var(--accent)
    }

    .settings-toggle.on::after {
      left: 23px;
      background: #000
    }

    .settings-toggle.disabled {
      opacity: 0.4;
      cursor: not-allowed
    }

    .settings-select {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--text);
      font-size: 0.85em;
      cursor: pointer;
      min-width: 140px
    }

    .settings-select:focus {
      outline: none;
      border-color: var(--accent)
    }

    .settings-select:disabled {
      opacity: 0.4;
      cursor: not-allowed
    }

    .settings-select option {
      background: var(--surface);
      color: var(--text)
    }

    .settings-status {
      font-size: 0.75em;
      color: var(--text2);
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 6px
    }

    .settings-status.saving {
      color: var(--accent)
    }

    .settings-status.saved {
      color: var(--accent)
    }

    .settings-status.error {
      color: var(--danger)
    }

    .settings-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px 24px;
      color: var(--text2);
      font-size: 0.9em
    }

    .settings-loading img {
      width: 100px;
      height: 100px;
      animation: spin 2s linear infinite;
      margin-bottom: 16px
    }

    /* Virtual Pager */
    #pager_ui {
      border-collapse: collapse;
      border-spacing: 0;
      margin: 0 auto;
    }

    #pager_ui td {
      padding: 0;
      margin: 0;
    }

    #pager_ui img {
      display: block;
    }

    .pager-btn {
      cursor: pointer;
      user-select: none;
      -webkit-user-drag: none;
      transition: filter 0.08s ease;
    }

    .pager-btn.pressed {
      filter: brightness(0.6);
    }

    #pager-container {
      background: #303030;
      padding: 10px;
      display: none;
      justify-content: center;
      border-bottom: 1px solid var(--border);
      overflow: hidden;
    }

    #pager_error {
      width: 480px;
      height: 222px;
      font-size: large;
      text-align: center;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      position: absolute;
      top: 0;
      left: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 5;
    }

    #pager {
      display: block;
    }

    /* Responsive Wrapper for Pager UI */
    .pager-scale-wrapper {
      transform-origin: top center;
      transition: transform 0.1s ease-out;
    }
  </style>
  <link rel="stylesheet" href="xterm.css">
  <script src="xterm.min.js"></script>
  <script src="xterm-addon-fit.min.js"></script>
</head>

<body>
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <img src="nautilus_logo.png" alt="Nautilus" onerror="this.style.display='none'">
      <h2>Nautilus</h2>
      <p>Enter root password to continue</p>
      <div class="login-error" id="loginError">Invalid password</div>
      <input type="password" id="loginPassword" placeholder="Password" onkeydown="if(event.key==='Enter')doLogin()">
      <button class="btn" onclick="doLogin()">Login</button>
    </div>
  </div>
  <div class="header">
    <div class="logo">
      <img src="nautilus_logo.png" alt="Nautilus" onerror="this.style.display='none'">
      <h1>Nautilus</h1>
    </div>
    <div class="header-right">
      <button class="settings-btn" onclick="openSettings()" title="Settings"><svg viewBox="0 0 24 24">
          <path
            d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
        </svg></button>
      <div class="status" id="status">Connecting...</div>
    </div>
  </div>
  <div class="wifi-bar" id="wifiBar">
    <svg class="wifi-icon disconnected" id="wifiIcon" viewBox="0 0 24 24">
      <path
        d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z" />
    </svg>
    <div class="wifi-status">
      <span class="wifi-ssid" id="wifiSsid" onclick="toggleSsidVisibility()" title="Click to show/hide SSID">Not
        connected</span>
      <span class="wifi-signal" id="wifiSignal"></span>
    </div>
    <div class="wifi-details" id="wifiDetails">
      <button class="wifi-btn primary" id="wifiBrowseBtn" onclick="openWifiModal()">
        <svg viewBox="0 0 24 24">
          <path
            d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z" />
        </svg>
        Browse Networks
      </button>
      <button class="wifi-btn danger" id="wifiDisconnectBtn" onclick="wifiDisconnect()" style="display:none">
        <svg viewBox="0 0 24 24">
          <path
            d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
        </svg>
        Disconnect
      </button>
      <div class="wifi-toggle">
        <span>Client Mode</span>
        <div class="toggle-switch on" id="wifiToggle" onclick="toggleClientMode()"></div>
      </div>
    </div>
  </div>
  <div class="wifi-modal" id="wifiModal" onclick="if(event.target===this)closeWifiModal()">
    <div class="wifi-modal-content" onclick="event.stopPropagation()">
      <div class="wifi-modal-header">
        <h3>Available Networks</h3>
        <button class="wifi-modal-close" onclick="closeWifiModal()"><svg viewBox="0 0 24 24">
            <path
              d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
          </svg></button>
      </div>
      <div class="wifi-modal-body" id="wifiModalBody">
        <div class="wifi-scan-status" id="wifiScanStatus">
          <div class="spinner"></div>
          Scanning for networks...
        </div>
        <div id="wifiNetworkList"></div>
      </div>
      <div class="wifi-password-section" id="wifiPasswordSection" style="display:none">
        <label>Password for <strong id="wifiSelectedSsid"></strong></label>
        <div class="password-input-wrap">
          <input type="password" id="wifiPasswordInput" placeholder="Enter password"
            onkeydown="if(event.key==='Enter')wifiConnectSelected()">
          <button class="show-pass-btn" onclick="togglePasswordVisibility()">Show</button>
        </div>
      </div>
      <div class="wifi-modal-footer">
        <button class="wifi-btn secondary" onclick="closeWifiModal()">Cancel</button>
        <button class="wifi-btn secondary" onclick="startWifiScan()">Rescan</button>
        <button class="wifi-btn primary" id="wifiConnectBtn" onclick="wifiConnectSelected()" disabled>Connect</button>
      </div>
    </div>
  </div>
  <div class="settings-modal" id="settingsModal" onclick="if(event.target===this)closeSettings()">
    <div class="settings-modal-content" onclick="event.stopPropagation()">
      <div class="settings-modal-header">
        <h3><svg viewBox="0 0 24 24">
            <path
              d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
          </svg>Settings</h3>
        <button class="settings-modal-close" onclick="closeSettings()"><svg viewBox="0 0 24 24">
            <path
              d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
          </svg></button>
      </div>
      <div class="settings-modal-body">
        <div class="settings-loading" id="settingsLoading">
          <img src="nautilus_spinning.png" alt="Loading">
          <div>Loading settings...</div>
        </div>
        <div class="settings-content" id="settingsContent" style="display:none">
          <div class="settings-section">
            <div class="settings-section-title"><svg viewBox="0 0 24 24">
                <path
                  d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
              </svg>Startup Behavior</div>
            <div class="settings-item">
              <div class="settings-item-header">
                <div class="settings-item-header-info">
                  <div class="settings-item-header-label">Auto-select Run Mode</div>
                </div>
                <div class="settings-toggle" id="toggleAutoMode" onclick="toggleAutoMode()"></div>
              </div>
              <div class="settings-item-body" id="autoModeBody">
                <div class="settings-item-info">
                  <div class="settings-item-label">Default Run Mode</div>
                  <div class="settings-item-desc">Skip the startup prompt and automatically run in this mode</div>
                </div>
                <select class="settings-select" id="selectRunMode" onchange="setRunMode(this.value)"
                  style="margin-top:10px">
                  <option value="foreground">Foreground</option>
                  <option value="background">Background</option>
                </select>
              </div>
            </div>
            <div class="settings-status" id="settingsStatus"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="container">
    <div class="sidebar">
      <div class="tabs-container">
        <div class="tabs-row favourites-row">
          <div class="tab favourites" data-tab="favourites" onclick="switchTab('favourites')"><svg viewBox="0 0 24 24">
              <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" />
            </svg>Favourites</div>
          
        </div>
        <div class="tabs-row resource-row">
          <div class="tab resource-tab active" data-resource="payloads" onclick="switchResource('payloads')"> Payloads
          </div>
          <div class="tab resource-tab" data-resource="alerts" onclick="switchResource('alerts')"> Alerts</div>
          <div class="tab resource-tab" data-resource="recon" onclick="switchResource('recon')"> Recon</div>
        </div>
        <div class="tabs-row resource-row">
          <div class="tab resource-tab" data-resource="themes" onclick="switchResource('themes')"> Themes</div>
          <div class="tab resource-tab" data-resource="ringtones" onclick="switchResource('ringtones')"> Ringtones</div>
          <div class="tab resource-tab" data-resource="loot" onclick="switchResource('loot')"> Loot</div>
        </div>

        <div class="tabs-row">
          <div class="tab active" data-tab="local" onclick="switchTab('local')"> Local</div>
          <div class="tab" data-tab="merged" onclick="switchTab('merged')"> Merged</div>
          <div class="tab" data-tab="prs" onclick="switchTab('prs')"> PRs</div>
        </div>
      </div>
      <div class="tab-content" id="tab-favourites">
        <div class="search"><input type="text" id="searchBoxFavourites" placeholder="Search favourites..."
            oninput="filterFavourites(this.value)"></div>
        <div id="favouritesList"></div>
      </div>
      <div class="tab-content active" id="tab-local">
        <div class="search"><input type="text" id="searchBox" placeholder="Search payloads..."
            oninput="filter(this.value)"></div>
        <div id="categories"></div>
      </div>
      <div class="tab-content" id="tab-merged">
        <div class="search-row">
          <input type="text" id="searchBoxMerged" placeholder="Search GitHub payloads..."
            oninput="filterMerged(this.value)">
          <button class="refresh-btn" id="refreshMerged" onclick="refreshGithubPayloads()"
            title="Refresh from GitHub"><svg viewBox="0 0 24 24">
              <path
                d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
            </svg></button>
        </div>
        <div class="cache-info" id="mergedCacheInfo"></div>
        <div id="githubCategories">
          <div class="github-loading"><img src="nautilus_spinning.png" alt="">Loading from GitHub...</div>
        </div>
      </div>
      <div class="tab-content" id="tab-prs">
        <div class="search-row">
          <input type="text" id="searchBoxPRs" placeholder="Search pull requests..." oninput="filterPRs(this.value)">
          <button class="refresh-btn" id="refreshPRs" onclick="refreshGithubPRs()" title="Refresh from GitHub"><svg
              viewBox="0 0 24 24">
              <path
                d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
            </svg></button>
        </div>
        <div class="cache-info" id="prsCacheInfo"></div>
        <div id="prList">
          <div class="github-loading"><img src="nautilus_spinning.png" alt="">Loading pull requests...</div>
        </div>
      </div>
    </div>
    <div class="resize-handle" id="resizeSidebar"></div>
    <div class="main">
      <div class="main-left">
        <div class="detail" id="detail">
          <div class="empty">
            <svg viewBox="0 0 24 24">
              <path
                d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
            </svg>
            <h3>Select a Payload</h3>
            <p>Choose from the sidebar</p>
          </div>
        </div>
      </div>
      <div class="resize-handle" id="resizeDetail"></div>
      <div class="main-right">
        <div class="console-panel">
          <div class="console-wrap">
            <div class="console-header"><span id="consoleTitle">Nautilus Console</span><span><button
                  onclick="clearConsole()">Clear</button> <span id="lineCount">0 lines</span></span></div>
            <div class="console" id="console"></div>
            <div class="source-viewer" id="sourceViewer" style="display:none"></div>
          </div>
          <div class="button-panel" id="buttonPanel">
            <div class="dpad">
              <button class="dpad-btn up" onclick="sendButton('UP')" title="UP"></button>
              <button class="dpad-btn left" onclick="sendButton('LEFT')" title="LEFT"></button>
              <div class="dpad-btn center"></div>
              <button class="dpad-btn right" onclick="sendButton('RIGHT')" title="RIGHT"></button>
              <button class="dpad-btn down" onclick="sendButton('DOWN')" title="DOWN"></button>
            </div>
            <div class="ab-btns">
              <button class="ab-btn btn-a" onclick="sendButton('A')" title="A Button">A</button>
              <button class="ab-btn btn-b" onclick="sendButton('B')" title="B Button">B</button>
            </div>
            <div class="waiting-hint" id="buttonHint">Waiting for <span class="expected" id="expectedButton">any</span>
              button...</div>
          </div>
        </div>
        <div class="resize-handle" id="resizeConsole"></div>
        <div class="shell-panel">
          <div class="console-header"><span>Pager Shell<span class="shell-status disconnected"
                id="shellStatus">disconnected</span></span><span><button onclick="togglePager()">Toggle Pager</button>
              <button onclick="reconnectShell()">Reconnect</button></span></div>
          <div id="pager-container">
            <div id="pagerScaleWrapper" class="pager-scale-wrapper">
              <table hidden id="pager_ui" width="745" height="531" border="0" cellpadding="0" cellspacing="0"
                style="display:block">
                <tr>
                  <td colspan="13"><img src="images/virtual_pager_01.png" width="744" height="67" alt=""></td>
                  <td><img src="images/spacer.gif" width="1" height="67" alt=""></td>
                </tr>
                <tr>
                  <td colspan="2" rowspan="3"><img src="images/virtual_pager_02.png" width="132" height="324" alt="">
                  </td>
                  <td colspan="9" style="position: relative; padding: 0; margin: 0; font-size: 0; line-height: 0;">
                    <!-- IMPORTANT: this is the live screen surface -->
                    <img id="pager" width="480" height="222" tabindex="0">
                    <!-- hidden canvas used to convert RGBA framebuffer -> PNG -->
                    <canvas id="pager_canvas" width="480" height="222" style="display:none;"></canvas>
                    <div id="pager_error" style="display: none;">
                      Lost connection to virtual pager
                      <br>
                      <button onclick="connectPager()">Reconnect</button>
                    </div>
                  </td>
                  <td colspan="2" rowspan="2"><img src="images/virtual_pager_04.png" width="132" height="287" alt="">
                  </td>
                  <td><img src="images/spacer.gif" width="1" height="222" alt=""></td>
                </tr>
                <tr>
                  <td colspan="9"><img src="images/virtual_pager_05.png" width="480" height="65" alt=""></td>
                  <td><img src="images/spacer.gif" width="1" height="65" alt=""></td>
                </tr>
                <tr>
                  <td colspan="4"><img src="images/virtual_pager_06.png" width="228" height="37" alt=""></td>
                  <td rowspan="5"><img class="pager-btn" src="images/LEFT.png"
                      onclick="keyws && keyws.send('ArrowLeft')" role="button" width="87" height="109" alt=""></td>
                  <td rowspan="6"><img src="images/virtual_pager_08.png" width="7" height="176" alt=""></td>
                  <td rowspan="2"><img class="pager-btn" src="images/UP.png" onclick="keyws && keyws.send('ArrowUp')"
                      role="button" width="139" height="49" alt=""></td>
                  <td rowspan="6"><img src="images/virtual_pager_10.png" width="9" height="176" alt=""></td>
                  <td colspan="2" rowspan="5"><img class="pager-btn" src="images/RIGHT.png"
                      onclick="keyws && keyws.send('ArrowRight')" role="button" width="86" height="109" alt=""></td>
                  <td rowspan="6"><img src="images/virtual_pager_12.png" width="56" height="176" alt=""></td>
                  <td><img src="images/spacer.gif" width="1" height="37" alt=""></td>
                </tr>
                <tr>
                  <td rowspan="5"><img src="images/virtual_pager_13.png" width="73" height="139" alt=""></td>
                  <td colspan="2" rowspan="3"><img class="pager-btn" src="images/B_Button.png"
                      onclick="keyws && keyws.send('Escape')" role="button" width="115" height="44" alt=""></td>
                  <td rowspan="5"><img src="images/virtual_pager_15.png" width="22" height="139" alt=""></td>
                  <td rowspan="3"><img class="pager-btn" src="images/A_Button.png"
                      onclick="keyws && keyws.send('Enter')" role="button" width="115" height="44" alt=""></td>
                  <td rowspan="5"><img src="images/virtual_pager_17.png" width="35" height="139" alt=""></td>
                  <td><img src="images/spacer.gif" width="1" height="12" alt=""></td>
                </tr>
                <tr>
                  <td><img src="images/virtual_pager_18.png" width="139" height="11" alt=""></td>
                  <td><img src="images/spacer.gif" width="1" height="11" alt=""></td>
                </tr>
                <tr>
                  <td rowspan="2"><img class="pager-btn" src="images/DOWN.png"
                      onclick="keyws && keyws.send('ArrowDown')" role="button" width="139" height="49" alt=""></td>
                  <td><img src="images/spacer.gif" width="1" height="21" alt=""></td>
                </tr>
                <tr>
                  <td colspan="2" rowspan="2"><img src="images/virtual_pager_20.png" width="115" height="95" alt="">
                  </td>
                  <td rowspan="2"><img src="images/virtual_pager_21.png" width="115" height="95" alt=""></td>
                  <td><img src="images/spacer.gif" width="1" height="28" alt=""></td>
                </tr>
                <tr>
                  <td><img src="images/virtual_pager_22.png" width="87" height="67" alt=""></td>
                  <td><img src="images/virtual_pager_23.png" width="139" height="67" alt=""></td>
                  <td colspan="2"><img src="images/virtual_pager_24.png" width="86" height="67" alt=""></td>
                  <td><img src="images/spacer.gif" width="1" height="67" alt=""></td>
                </tr>
                <tr>
                  <td><img src="images/spacer.gif" width="73" height="1" alt=""></td>
                  <td><img src="images/spacer.gif" width="59" height="1" alt=""></td>
                  <td><img src="images/spacer.gif" width="56" height="1" alt=""></td>
                  <td><img src="images/spacer.gif" width="22" height="1" alt=""></td>
                  <td><img src="images/spacer.gif" width="115" height="1" alt=""></td>
                  <td><img src="images/spacer.gif" width="35" height="1" alt=""></td>
                  <td><img src="images/spacer.gif" width="87" height="1" alt=""></td>
                  <td><img src="images/spacer.gif" width="7" height="1" alt=""></td>
                  <td><img src="images/spacer.gif" width="139" height="1" alt=""></td>
                  <td><img src="images/spacer.gif" width="9" height="1" alt=""></td>
                  <td><img src="images/spacer.gif" width="10" height="1" alt=""></td>
                  <td><img src="images/spacer.gif" width="76" height="1" alt=""></td>
                  <td><img src="images/spacer.gif" width="56" height="1" alt=""></td>
                  <td></td>
                </tr>
              </table>
            </div>
          </div>

          <div class="resize-handle-v" id="resizePager"></div>
          <div id="shellTerminal"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="modalOverlay"
    onclick="if(event.target===this){if(installing){stopInstall();}$('modalOverlay').classList.remove('show');}">
    <div class="modal" onclick="event.stopPropagation()">
      <button class="modal-peek-btn" title="Hold to peek behind" onmousedown="$('modalOverlay').classList.add('peek')"
        onmouseup="$('modalOverlay').classList.remove('peek')"
        onmouseleave="$('modalOverlay').classList.remove('peek')"><svg viewBox="0 0 24 24">
          <path
            d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" />
        </svg></button>
      <div class="modal-title" id="modalTitle">Confirm</div>
      <div class="modal-message" id="modalMessage"></div>
      <input type="text" class="modal-input" id="modalInput" style="display:none">
      <div class="modal-buttons">
        <button class="btn secondary" id="modalCancel" onclick="respondPrompt(false)">Cancel</button>
        <button class="btn" id="modalConfirm" onclick="respondPrompt(true)">Confirm</button>
      </div>
    </div>
  </div>
  <div class="spinner-overlay" id="spinnerOverlay">
    <div class="spinner-box">
      <button class="spinner-kill" onclick="stop()" title="Stop payload"><svg viewBox="0 0 24 24">
          <path
            d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
        </svg></button>
      <img src="nautilus_spinning.png" alt="Loading">
      <div class="spinner-text" id="spinnerText">Loading...</div>
    </div>
  </div>
  <script>
    let allData = { payloads: {}, alerts: {}, recon: {}, themes: {}, ringtones: {} };
    let payloads = {}, filtered = {}, selected = null, running = false, evtSource = null, lineCount = 0;
    let activeSpinners = {};
    let currentTab = 'local';
    let currentResource = 'payloads';
    let runningSection = null;
    let viewingSource = false;
    let githubPayloads = {}, filteredGithub = {}, githubPRs = [], filteredPRs = [];
    let favourites = [], filteredFavourites = [];
    const $ = id => document.getElementById(id);
    const RESOURCE_REPOS = { payloads: 'wifipineapplepager-payloads', alerts: 'wifipineapplepager-payloads', recon: 'wifipineapplepager-payloads', themes: 'wifipineapplepager-themes', ringtones: 'wifipineapplepager-ringtones' };
    const RESOURCE_BRANCHES = { payloads: 'master', alerts: 'master', recon: 'master', themes: 'master', ringtones: 'master' };
    const RESOURCE_PATHS = { payloads: 'library/user', alerts: 'library/alerts', recon: 'library/recon', themes: 'themes', ringtones: 'ringtones' };

    let shellTerm = null, shellWs = null, shellFitAddon = null;
    const TTYD_CMD_INPUT = '0', TTYD_CMD_RESIZE = '1', TTYD_CMD_OUTPUT = 48, TTYD_CMD_TITLE = 49, TTYD_CMD_PREFS = 50;

    function initShell() {
      if (typeof Terminal === 'undefined') {
        console.error('xterm.js not loaded');
        $('shellStatus').textContent = 'xterm not loaded';
        return;
      }
      shellTerm = new Terminal({ cursorBlink: true, fontSize: 13, fontFamily: "'JetBrains Mono','Fira Code','Consolas',monospace", theme: { background: '#050508', foreground: '#e8e8e8', cursor: '#00d4aa' } });
      shellFitAddon = new FitAddon.FitAddon();
      shellTerm.loadAddon(shellFitAddon);
      shellTerm.open($('shellTerminal'));
      shellFitAddon.fit();
      shellTerm.onData(data => {
        if (shellWs && shellWs.readyState === 1) {
          const enc = new TextEncoder();
          const payload = new Uint8Array(data.length * 3 + 1);
          payload[0] = TTYD_CMD_INPUT.charCodeAt(0);
          const stats = enc.encodeInto(data, payload.subarray(1));
          shellWs.send(payload.subarray(0, stats.written + 1));
        }
      });
      window.addEventListener('resize', () => { if (shellFitAddon) setTimeout(() => { shellFitAddon.fit(); sendShellResize(); }, 50); });
      new ResizeObserver(() => { if (shellFitAddon) { shellFitAddon.fit(); sendShellResize(); } }).observe($('shellTerminal'));
      $('shellTerminal').addEventListener('click', () => { if (shellTerm) shellTerm.focus(); });
    }

    function sendShellResize() {
      if (shellWs && shellWs.readyState === 1 && shellTerm) {
        const msg = JSON.stringify({ columns: shellTerm.cols, rows: shellTerm.rows });
        const enc = new TextEncoder();
        shellWs.send(enc.encode(TTYD_CMD_RESIZE + msg));
      }
    }

    function connectShell() {
      if (shellWs && shellWs.readyState < 2) return;
      $('shellStatus').textContent = 'connecting...';
      $('shellStatus').className = 'shell-status disconnected';
      const wsProto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = wsProto + '//' + location.hostname + ':7681/ws';
      shellWs = new WebSocket(wsUrl, ['tty']);
      shellWs.binaryType = 'arraybuffer';
      shellWs.onopen = () => {
        $('shellStatus').textContent = 'connected';
        $('shellStatus').className = 'shell-status connected';
        if (shellFitAddon) shellFitAddon.fit();
        const cols = shellTerm ? shellTerm.cols : 80, rows = shellTerm ? shellTerm.rows : 24;
        const initMsg = JSON.stringify({ AuthToken: '', columns: cols, rows: rows });
        shellWs.send(new TextEncoder().encode(initMsg));
        if (shellTerm) shellTerm.focus();
      };
      shellWs.onmessage = e => {
        if (!shellTerm) return;
        const arr = new Uint8Array(e.data);
        if (arr.length > 0) {
          const cmd = arr[0];
          const data = arr.slice(1);
          if (cmd === TTYD_CMD_OUTPUT) {
            shellTerm.write(data);
          } else if (cmd === TTYD_CMD_TITLE) {
            const title = new TextDecoder().decode(data);
            console.log('[ttyd] title:', title);
          } else if (cmd === TTYD_CMD_PREFS) {
            const prefs = JSON.parse(new TextDecoder().decode(data));
            console.log('[ttyd] prefs:', prefs);
          }
        }
      };
      shellWs.onclose = e => {
        $('shellStatus').textContent = 'disconnected (' + e.code + ')';
        $('shellStatus').className = 'shell-status disconnected';
        shellWs = null;
      };
      shellWs.onerror = e => {
        console.error('[ttyd] ws error:', e);
        $('shellStatus').textContent = 'error';
        $('shellStatus').className = 'shell-status disconnected';
      };
    }

    function reconnectShell() {
      if (shellWs) { shellWs.close(); shellWs = null; }
      setTimeout(connectShell, 300);
    }

    let wifiStatus = { connected: false, ssid: '', signal: '', client_mode_enabled: false };
    let wifiNetworks = [];
    let selectedNetwork = null;
    let wifiScanEvt = null;
    let wifiConnectEvt = null;
    let wifiLoading = true;
    let ssidVisible = false;

    function toggleSsidVisibility() {
      if (!wifiStatus.connected || !wifiStatus.ssid) return;
      ssidVisible = !ssidVisible;
      updateWifiBar();
    }

    function maskSsid(ssid) {
      return ''.repeat(Math.min(ssid.length, 12));
    }

    async function loadWifiStatus() {
      wifiLoading = true;
      updateWifiBar();
      try {
        const r = await fetch('/cgi-bin/api.sh?action=wifi_status');
        const d = await r.json();
        wifiStatus = d;
      } catch (e) { console.error('WiFi status error:', e); }
      wifiLoading = false;
      updateWifiBar();
    }

    function updateWifiBar() {
      const icon = $('wifiIcon');
      const ssid = $('wifiSsid');
      const signal = $('wifiSignal');
      const toggle = $('wifiToggle');
      const disconnectBtn = $('wifiDisconnectBtn');
      const browseBtn = $('wifiBrowseBtn');
      const wifiBar = $('wifiBar');

      if (wifiLoading) {
        wifiBar.style.opacity = '0.6';
        wifiBar.style.pointerEvents = 'none';
        icon.classList.add('disconnected');
        icon.classList.remove('connected');
        ssid.textContent = 'Loading...';
        signal.textContent = '';
        disconnectBtn.style.display = 'none';
        browseBtn.style.display = 'none';
        toggle.classList.remove('on');
        return;
      }

      wifiBar.style.opacity = '1';
      wifiBar.style.pointerEvents = '';

      if (wifiStatus.client_mode_enabled) {
        toggle.classList.add('on');
        browseBtn.style.display = '';
      } else {
        toggle.classList.remove('on');
        browseBtn.style.display = 'none';
        disconnectBtn.style.display = 'none';
        icon.classList.add('disconnected');
        icon.classList.remove('connected');
        ssid.textContent = 'Client mode disabled';
        signal.textContent = '';
        return;
      }

      if (wifiStatus.connected && wifiStatus.ssid) {
        icon.classList.remove('disconnected');
        icon.classList.add('connected');
        ssid.textContent = ssidVisible ? wifiStatus.ssid : maskSsid(wifiStatus.ssid);
        ssid.classList.add('clickable');
        ssid.title = ssidVisible ? 'Click to hide SSID' : 'Click to show SSID';
        signal.textContent = wifiStatus.signal || '';
        disconnectBtn.style.display = '';
        browseBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/></svg>Change Network';
      } else {
        icon.classList.add('disconnected');
        icon.classList.remove('connected');
        ssid.textContent = 'Not connected';
        ssid.classList.remove('clickable');
        ssid.title = '';
        signal.textContent = '';
        disconnectBtn.style.display = 'none';
        browseBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/></svg>Browse Networks';
      }
    }

    function openWifiModal() {
      $('wifiModal').classList.add('show');
      $('wifiPasswordSection').style.display = 'none';
      $('wifiConnectBtn').disabled = true;
      $('wifiConnectBtn').textContent = 'Connect';
      selectedNetwork = null;
      startWifiScan();
    }

    function closeWifiModal() {
      $('wifiModal').classList.remove('show');
      if (wifiScanEvt) { wifiScanEvt.close(); wifiScanEvt = null; }
      if (wifiConnectEvt) { wifiConnectEvt.close(); wifiConnectEvt = null; }
    }

    function startWifiScan() {
      $('wifiScanStatus').style.display = 'block';
      $('wifiScanStatus').innerHTML = '<div class="spinner"></div>Scanning for networks...';
      $('wifiNetworkList').innerHTML = '';
      $('wifiPasswordSection').style.display = 'none';
      $('wifiConnectBtn').disabled = true;
      selectedNetwork = null;
      wifiNetworks = [];

      if (wifiScanEvt) { wifiScanEvt.close(); }
      wifiScanEvt = new EventSource('/cgi-bin/api.sh?action=wifi_scan');

      wifiScanEvt.onmessage = e => {
        try {
          const d = JSON.parse(e.data);
          if (d.type === 'status') {
            $('wifiScanStatus').innerHTML = '<div class="spinner"></div>' + d.message;
          } else if (d.type === 'error') {
            $('wifiScanStatus').innerHTML = '<span style="color:#e74c3c">' + d.message + '</span>';
          }
        } catch (err) { }
      };

      wifiScanEvt.addEventListener('done', e => {
        wifiScanEvt.close();
        wifiScanEvt = null;
        try {
          const d = JSON.parse(e.data);
          wifiNetworks = d.networks || [];
          renderWifiNetworks();
        } catch (err) {
          $('wifiScanStatus').innerHTML = '<span style="color:#e74c3c">Scan failed</span>';
        }
      });

      wifiScanEvt.onerror = () => {
        wifiScanEvt.close();
        wifiScanEvt = null;
        $('wifiScanStatus').innerHTML = '<span style="color:#e74c3c">Scan connection lost</span>';
      };
    }

    function renderWifiNetworks() {
      $('wifiScanStatus').style.display = 'none';
      const list = $('wifiNetworkList');

      if (wifiNetworks.length === 0) {
        list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text2)">No networks found</div>';
        return;
      }

      wifiNetworks.sort((a, b) => {
        const sigA = parseInt(a.signal) || -100;
        const sigB = parseInt(b.signal) || -100;
        return sigB - sigA;
      });

      const seen = new Set();
      const unique = wifiNetworks.filter(n => {
        if (!n.ssid || seen.has(n.ssid)) return false;
        seen.add(n.ssid);
        return true;
      });

      list.innerHTML = unique.map((n, i) => {
        const isSecured = n.encryption && n.encryption !== 'Open' && n.encryption !== 'none';
        const signalBars = getSignalBars(n.signal);
        const lockIcon = isSecured ? '<svg class="wifi-net-lock" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>' : '';
        return `<div class="wifi-network" data-idx="${i}" onclick="selectWifiNetwork(${i})">
      <div class="wifi-net-signal">${signalBars}</div>
      <div class="wifi-net-info">
        <div class="wifi-net-ssid">${escHtml(n.ssid)}</div>
        <div class="wifi-net-details"><span>Ch ${n.channel || '?'}</span><span>${n.signal || ''}</span><span>${n.encryption || 'Open'}</span></div>
      </div>
      ${lockIcon}
    </div>`;
      }).join('');
    }

    function getSignalBars(signal) {
      const sig = parseInt(signal) || -100;
      let bars = 1;
      if (sig > -50) bars = 4;
      else if (sig > -60) bars = 3;
      else if (sig > -70) bars = 2;
      let color = '#e74c3c';
      if (bars >= 4) color = '#00ff88';
      else if (bars >= 3) color = '#2ecc71';
      else if (bars >= 2) color = '#f39c12';
      const heights = [4, 8, 12, 16];
      return heights.map((h, i) => `<span style="height:${h}px;background:${i < bars ? color : 'var(--border)'};opacity:1"></span>`).join('');
    }

    function selectWifiNetwork(idx) {
      document.querySelectorAll('.wifi-network').forEach(el => el.classList.remove('selected'));
      const el = document.querySelector(`.wifi-network[data-idx="${idx}"]`);
      if (el) el.classList.add('selected');

      selectedNetwork = wifiNetworks.filter((n, i, arr) => {
        const seen = new Set();
        return arr.findIndex(x => x.ssid === n.ssid) === i;
      })[idx];

      if (!selectedNetwork) return;

      const isSecured = selectedNetwork.encryption && selectedNetwork.encryption !== 'Open' && selectedNetwork.encryption !== 'none';

      if (isSecured) {
        $('wifiPasswordSection').style.display = 'block';
        $('wifiSelectedSsid').textContent = selectedNetwork.ssid;
        $('wifiPasswordInput').value = '';
        $('wifiPasswordInput').focus();
        $('wifiConnectBtn').disabled = false;
      } else {
        $('wifiPasswordSection').style.display = 'none';
        $('wifiConnectBtn').disabled = false;
      }
    }

    function togglePasswordVisibility() {
      const inp = $('wifiPasswordInput');
      const btn = inp.nextElementSibling;
      if (inp.type === 'password') {
        inp.type = 'text';
        btn.textContent = 'Hide';
      } else {
        inp.type = 'password';
        btn.textContent = 'Show';
      }
    }

    async function wifiConnectSelected() {
      if (!selectedNetwork) return;

      const password = $('wifiPasswordInput').value;
      const isSecured = selectedNetwork.encryption && selectedNetwork.encryption !== 'Open' && selectedNetwork.encryption !== 'none';

      if (isSecured && !password) {
        $('wifiPasswordInput').style.borderColor = '#e74c3c';
        $('wifiPasswordInput').focus();
        return;
      }

      $('wifiConnectBtn').disabled = true;
      $('wifiConnectBtn').textContent = 'Connecting...';

      const params = new URLSearchParams({
        action: 'wifi_connect',
        ssid: selectedNetwork.ssid,
        password: password || '',
        encryption: selectedNetwork.encryption || 'Open',
        bssid: selectedNetwork.bssid || ''
      });

      if (wifiConnectEvt) { wifiConnectEvt.close(); }
      wifiConnectEvt = new EventSource('/cgi-bin/api.sh?' + params.toString());

      wifiConnectEvt.onmessage = e => {
        try {
          const d = JSON.parse(e.data);
          $('wifiConnectBtn').textContent = d.message || 'Connecting...';
        } catch (err) { }
      };

      wifiConnectEvt.addEventListener('done', e => {
        wifiConnectEvt.close();
        wifiConnectEvt = null;
        try {
          const d = JSON.parse(e.data);
          if (d.success) {
            closeWifiModal();
            loadWifiStatus();
          } else {
            $('wifiConnectBtn').textContent = 'Connect';
            $('wifiConnectBtn').disabled = false;
            $('wifiPasswordInput').style.borderColor = '#e74c3c';
            alert('Connection failed: ' + (d.error || 'Unknown error'));
          }
        } catch (err) {
          $('wifiConnectBtn').textContent = 'Connect';
          $('wifiConnectBtn').disabled = false;
        }
      });

      wifiConnectEvt.onerror = () => {
        wifiConnectEvt.close();
        wifiConnectEvt = null;
        $('wifiConnectBtn').textContent = 'Connect';
        $('wifiConnectBtn').disabled = false;
      };
    }

    async function wifiDisconnect() {
      wifiLoading = true;
      updateWifiBar();
      try {
        const r = await fetch('/cgi-bin/api.sh?action=wifi_disconnect');
        const d = await r.json();
        await loadWifiStatus();
      } catch (e) {
        console.error('Disconnect error:', e);
        wifiLoading = false;
        updateWifiBar();
      }
    }

    async function toggleClientMode() {
      const toggle = $('wifiToggle');
      const newState = !toggle.classList.contains('on');

      wifiLoading = true;
      updateWifiBar();

      try {
        const r = await fetch('/cgi-bin/api.sh?action=wifi_toggle&enable=' + (newState ? '1' : '0'));
        const d = await r.json();
        await loadWifiStatus();
      } catch (e) {
        console.error('Toggle error:', e);
        wifiLoading = false;
        updateWifiBar();
      }
    }

    function switchResource(res) {
      currentResource = res;
      document.querySelectorAll('.resource-tab').forEach(t => t.classList.toggle('active', t.dataset.resource === res));
      
      // Loot is local-only, hide GitHub tabs
      const isLoot = res === 'loot';
      document.querySelectorAll('.tab[data-tab="merged"], .tab[data-tab="prs"]').forEach(t => t.style.display = isLoot ? 'none' : '');
      
      if (isLoot) {
        // Fetch loot live - no cache needed
        switchTab('local');
        loadLootLive();
      } else {
        // Load live local data if on local tab
        if (currentTab === 'local') {
          loadLocalResourceLive(res);
        } else {
          // Fallback to cache while switching to non-local tab
          payloads = allData[res] || {};
          filtered = payloads;
          render();
        }

        const resLabel = res.charAt(0).toUpperCase() + res.slice(1);
        $('searchBox').placeholder = 'Search ' + resLabel.toLowerCase() + '...';
        $('searchBoxMerged').placeholder = 'Search GitHub ' + resLabel.toLowerCase() + '...';
        
        // Clear cached data for new resource
        githubPayloads = {};
        filteredGithub = {};
        githubPRs = [];
        filteredPRs = [];
        
        if (currentTab === 'merged') loadGithubPayloads();
        if (currentTab === 'prs') loadGithubPRs();

        // Remove loot header if exists
        const lootHeader = document.getElementById('lootHeader');
        if (lootHeader) lootHeader.remove();
      }
    }

    async function loadLocalResourceLive(type) {
      $('status').textContent = 'Scanning ' + type + '...';
      try {
        const resp = await fetch('cgi-bin/api.sh?action=scan_local&path=' + encodeURIComponent(type));
        const data = await resp.json();
        
        allData[type] = data;
        
        if (currentResource === type && currentTab === 'local') {
          payloads = data;
          filtered = payloads;
          render();
          
          const total = Object.values(payloads).flat().length;
          const resLabel = type.charAt(0).toUpperCase() + type.slice(1);
          $('status').textContent = 'Ready  ' + total + ' ' + resLabel.toLowerCase();
        }
      } catch (e) {
        console.error(e);
        if (currentResource === type && currentTab === 'local') {
          $('status').textContent = 'Error loading ' + type;
          payloads = {};
          filtered = {};
          render();
        }
      }
    }

    async function loadLootLive() {
      $('status').textContent = 'Loading loot...';
      try {
        const resp = await fetch('cgi-bin/api.sh?action=scan_loot');
        const data = await resp.json();
        payloads = data;
        allData.loot = data;  // Update cache too
        filtered = payloads;
        render();
        $('searchBox').placeholder = 'Search loot...';
        const total = Object.values(payloads).flat().length;
        $('status').textContent = 'Ready  ' + total + ' loot files';
        renderLootHeader();
      } catch (e) {
        $('status').textContent = 'Error loading loot';
        payloads = {};
        filtered = {};
        render();
      }
    }

    function renderLootHeader() {
      let header = document.getElementById('lootHeader');
      if (!header) {
        header = document.createElement('div');
        header.id = 'lootHeader';
        header.style.cssText = 'padding:8px 12px;background:var(--card);border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;';
        const localTab = document.getElementById('tab-local');
        if (localTab) localTab.insertBefore(header, localTab.firstChild);
      }
      const total = Object.values(payloads).flat().length;
      header.innerHTML = '<span style="flex:1;font-size:0.85em;color:var(--text2)"> ' + total + ' loot files</span>' +
        '<button class="btn secondary" style="padding:4px 10px;font-size:0.8em" onclick="downloadAllLoot()"><svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor" style="margin-right:4px"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>Download All</button>';
    }

    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab:not(.resource-tab)').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === 'tab-' + tab));
      selected = null;
      renderDetail();
      
      if (tab === 'local') {
        if (currentResource === 'loot') loadLootLive();
        else loadLocalResourceLive(currentResource);
      }
      
      if (tab === 'merged' && Object.keys(githubPayloads).length === 0) loadGithubPayloads();
      if (tab === 'prs' && githubPRs.length === 0) loadGithubPRs();
      if (tab === 'favourites') renderFavourites();
    }

    function filterMerged(q) {
      q = q.toLowerCase();
      if (!q) { filteredGithub = githubPayloads; }
      else {
        filteredGithub = {};
        for (const [cat, list] of Object.entries(githubPayloads)) {
          const m = list.filter(p => (p.title + p.description + p.author).toLowerCase().includes(q));
          if (m.length) filteredGithub[cat] = m;
        }
      }
      renderGithub();
    }

    function filterPRs(q) {
      q = q.toLowerCase();
      if (!q) { filteredPRs = githubPRs; }
      else { filteredPRs = githubPRs.filter(pr => (pr.title + pr.user + '#' + pr.number).toLowerCase().includes(q)); }
      renderPRs();
    }

    function filterFavourites(q) {
      q = q.toLowerCase();
      if (!q) { filteredFavourites = [...favourites]; }
      else { filteredFavourites = favourites.filter(f => (f.name + f.source).toLowerCase().includes(q)); }
      renderFavourites();
    }

    async function loadFavourites() {
      try {
        const resp = await fetch('/cgi-bin/api.sh?action=get_favourites');
        const data = await resp.json();
        if (data.success && Array.isArray(data.favourites)) {
          favourites = data.favourites;
          filteredFavourites = [...favourites];
        }
      } catch (e) { console.error('Failed to load favourites:', e); }
    }

    async function saveFavourites() {
      try {
        await fetch('/cgi-bin/api.sh?action=set_favourites', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ favourites })
        });
      } catch (e) { console.error('Failed to save favourites:', e); }
    }

    function isFavourite(path, source) {
      return favourites.some(f => f.path === path && f.source === source);
    }

    async function toggleFavourite(path, source, name) {
      const idx = favourites.findIndex(f => f.path === path && f.source === source);
      if (idx >= 0) {
        favourites.splice(idx, 1);
      } else {
        favourites.push({ path, source, name });
      }
      filteredFavourites = [...favourites];
      await saveFavourites();
      if (currentTab === 'favourites') renderFavourites();
      updateFavBtn();
    }

    function updateFavBtn() {
      const btn = $('favBtn');
      if (!btn || !selected) return;
      const source = selected.isGithub ? 'merged' : 'local';
      const path = selected.path;
      const isFav = isFavourite(path, source);
      btn.classList.toggle('active', isFav);
      btn.title = isFav ? 'Remove from Favourites' : 'Add to Favourites';
    }

    function renderFavourites() {
      if (filteredFavourites.length === 0) {
        $('favouritesList').innerHTML = '<div class="empty"><h3>No Favourites</h3><p>Star payloads from Local or Merged tabs to add them here</p></div>';
        return;
      }
      const sorted = [...filteredFavourites].sort((a, b) => (a.name || '').toLowerCase().localeCompare((b.name || '').toLowerCase()));
      let html = '';
      for (const fav of sorted) {
        const badgeClass = fav.source === 'local' ? 'local' : 'merged';
        const badgeText = fav.source === 'local' ? 'Local' : 'Merged';
        html += '<div class="payload" data-fav-path="' + escHtml(fav.path) + '" data-fav-source="' + escHtml(fav.source) + '" onclick="selectFavourite(\'' + escHtml(fav.path) + '\',\'' + escHtml(fav.source) + '\')"><div class="name">' + escHtml(fav.name) + '<span class="source-badge ' + badgeClass + '">' + badgeText + '</span></div></div>';
      }
      $('favouritesList').innerHTML = html;
    }

    function selectFavourite(path, source) {
      if (source === 'local') {
        for (const cat in payloads) {
          const found = payloads[cat].find(p => p.path === path);
          if (found) {
            selectFavouriteLocal(found, cat);
            return;
          }
        }
        $('detail').innerHTML = '<div class="empty"><h3>Not Found</h3><p>This local payload no longer exists</p><button class="btn secondary" style="margin-top:12px" onclick="removeStaleFavourite(\'' + escHtml(path) + '\',\'local\')"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>Remove from Favourites</button></div>';
      } else if (source === 'merged') {
        for (const cat in githubPayloads) {
          const found = githubPayloads[cat].find(p => p.path === path);
          if (found) {
            selectFavouriteMerged(found);
            return;
          }
        }
        if (Object.keys(githubPayloads).length === 0) {
          loadGithubPayloads().then(() => selectFavourite(path, source));
          return;
        }
        $('detail').innerHTML = '<div class="empty"><h3>Not Found</h3><p>This merged payload no longer exists on GitHub</p><button class="btn secondary" style="margin-top:12px" onclick="removeStaleFavourite(\'' + escHtml(path) + '\',\'merged\')"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>Remove from Favourites</button></div>';
      }
    }

    async function removeStaleFavourite(path, source) {
      const idx = favourites.findIndex(f => f.path === path && f.source === source);
      if (idx >= 0) {
        favourites.splice(idx, 1);
        filteredFavourites = [...favourites];
        await saveFavourites();
        renderFavourites();
        $('detail').innerHTML = '<div class="empty">Select a payload</div>';
      }
    }

    function selectFavouriteLocal(found, cat) {
      if (running && runningSection !== 'local') stop();
      hideSource();
      document.querySelectorAll('.payload').forEach(p => p.classList.remove('active'));
      const el = document.querySelector('.payload[data-fav-path="' + found.path + '"][data-fav-source="local"]');
      if (el) el.classList.add('active');
      selected = found;
      const author = selected.author ? escHtml(selected.author) : '';
      const desc = selected.desc ? escHtml(selected.desc) : '';
      const authorHtml = author ? '<span><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>' + author + '</span>' : '';
      const descHtml = desc ? '<div class="description">' + desc + '</div>' : '';
      const isNautilus = selected.path.includes('/remote_access/nautilus/');
      const deleteRow = isNautilus ? '' : '<button class="btn secondary btn-half" id="deleteBtn" onclick="deletePayload()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>Delete</button>';
      const favActive = isFavourite(selected.path, 'local') ? 'active' : '';
      $('detail').innerHTML = '<div style="display:flex;align-items:center;justify-content:space-between"><h2>' + escHtml(selected.name) + '</h2><button class="fav-btn ' + favActive + '" id="favBtn" onclick="toggleFavourite(\'' + escHtml(selected.path) + '\',\'local\',\'' + escHtml(selected.name) + '\')" title="' + (favActive ? 'Remove from Favourites' : 'Add to Favourites') + '"><svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></button></div><div class="meta">' + authorHtml + '<span><svg viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg>' + cat + '</span></div>' + descHtml + '<div class="actions"><div class="btn-row"><button class="btn" id="runBtn" onclick="run()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M8 5v14l11-7z"/></svg><span id="runBtnText">Run Payload</span></button><button class="btn secondary" id="sourceBtn" onclick="toggleSource()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg><span id="sourceBtnText">View Source</span></button></div>' + deleteRow + '</div>';
      updateRunBtn();
    }

    function selectFavouriteMerged(found) {
      if (running && runningSection !== 'merged') stop();
      hideSource();
      document.querySelectorAll('.payload').forEach(p => p.classList.remove('active'));
      const el = document.querySelector('.payload[data-fav-path="' + found.path + '"][data-fav-source="merged"]');
      if (el) el.classList.add('active');
      selected = { ...found, isGithub: true };
      const authorHtml = found.author ? '<span><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>' + escHtml(found.author) + '</span>' : '';
      const versionHtml = found.version ? '<span><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>v' + escHtml(found.version) + '</span>' : '';
      const ghUrl = 'https://github.com/' + getRepo() + '/tree/' + getBranch() + '/' + found.path;
      const favActive = isFavourite(found.path, 'merged') ? 'active' : '';
      $('detail').innerHTML = '<div style="display:flex;align-items:center;justify-content:space-between"><h2>' + escHtml(found.title) + '</h2><button class="fav-btn ' + favActive + '" id="favBtn" onclick="toggleFavourite(\'' + escHtml(found.path) + '\',\'merged\',\'' + escHtml(found.title) + '\')" title="' + (favActive ? 'Remove from Favourites' : 'Add to Favourites') + '"><svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></button></div><div class="meta">' + authorHtml + versionHtml + '<span><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>GitHub</span></div><div class="description">' + escHtml(found.description || 'No description') + '</div><a href="' + ghUrl + '" target="_blank" class="btn secondary" style="width:100%;margin-bottom:8px"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>View on GitHub</a><div class="actions"><div class="btn-row"><button class="btn" id="runBtn" onclick="runGithub()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M8 5v14l11-7z"/></svg><span id="runBtnText">Run Payload</span></button><button class="btn secondary" id="sourceBtn" onclick="toggleSource()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg><span id="sourceBtnText">View Source</span></button></div><button class="btn secondary btn-half" id="installBtn" onclick="installGithub()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>Install Locally</button></div>';
      updateRunBtn();
      updateInstallBtn();
    }

    const GITHUB_ORG = 'hak5';
    const GITHUB_BRANCH = 'master';
    const GITHUB_API = 'https://api.github.com';
    const GITHUB_RAW = 'https://raw.githubusercontent.com';
    const CACHE_KEY_MERGED = 'nautilus_github_merged';
    const CACHE_KEY_PRS = 'nautilus_github_prs';
    const CACHE_KEY_PR_FILES = 'nautilus_pr_files';

    function getRepo() {
      return GITHUB_ORG + '/' + (RESOURCE_REPOS[currentResource] || 'wifipineapplepager-payloads');
    }

    function getBranch() {
      return RESOURCE_BRANCHES[currentResource] || 'master';
    }

    function updateCacheInfo(id, timestamp) {
      const el = $(id);
      if (!el) return;
      if (!timestamp) { el.textContent = ''; el.style.display = 'none'; return; }
      const d = new Date(timestamp);
      el.textContent = 'Cached: ' + d.toLocaleString();
      el.style.display = 'block';
    }

    async function loadGithubPayloads(forceRefresh = false) {
      $('githubCategories').innerHTML = '<div class="github-loading"><img src="nautilus_spinning.png" alt="">Loading from GitHub...</div>';
      $('refreshMerged').classList.add('loading');

      const resourcePath = RESOURCE_PATHS[currentResource] || 'library/user';
      const cacheKey = CACHE_KEY_MERGED + '_' + currentResource;

      if (!forceRefresh) {
        try {
          const cached = localStorage.getItem(cacheKey);
          if (cached) {
            const data = JSON.parse(cached);
            githubPayloads = data.payloads;
            filteredGithub = githubPayloads;
            updateCacheInfo('mergedCacheInfo', data.timestamp);
            renderGithub();
            $('refreshMerged').classList.remove('loading');
            return;
          }
        } catch (e) { console.error('Cache read error:', e); }
      }

      try {
        const repo = getRepo();
        const branch = getBranch();
        const treeResp = await fetch(`${GITHUB_API}/repos/${repo}/git/trees/${branch}?recursive=1`);
        if (!treeResp.ok) throw new Error('GitHub API error: ' + treeResp.status);
        const treeData = await treeResp.json();

        githubPayloads = {};

        if (currentResource === 'themes') {
          // Themes: look for themes/<name>/theme.json
          const themePaths = treeData.tree
            .filter(f => f.type === 'blob' && f.path.match(/^themes\/[^/]+\/theme\.json$/))
            .map(f => f.path);

          const cat = 'themes';
          githubPayloads[cat] = [];
          for (const p of themePaths) {
            const parts = p.split('/');
            const name = parts[1];
            try {
              const jsonResp = await fetch(`${GITHUB_RAW}/${repo}/${branch}/${p}`);
              if (!jsonResp.ok) {
                githubPayloads[cat].push({ name, title: name, description: '', author: '', version: '', path: p.replace('/theme.json', ''), rawUrl: `${GITHUB_RAW}/${repo}/${branch}/${p}` });
                continue;
              }
              const jsonContent = await jsonResp.json();
              githubPayloads[cat].push({
                name,
                title: jsonContent.name || name,
                description: jsonContent.description || '',
                author: jsonContent.author || '',
                version: jsonContent.version || '',
                path: p.replace('/theme.json', ''),
                rawUrl: `${GITHUB_RAW}/${repo}/${branch}/${p}`
              });
            } catch (e) {
              githubPayloads[cat].push({ name, title: name, description: '', author: '', version: '', path: p.replace('/theme.json', ''), rawUrl: `${GITHUB_RAW}/${repo}/${branch}/${p}` });
            }
          }
        } else if (currentResource === 'ringtones') {
          // Ringtones: look for ringtones/<name>.rtttl
          const ringtonePaths = treeData.tree
            .filter(f => f.type === 'blob' && f.path.match(/^ringtones\/[^/]+\.rtttl$/))
            .map(f => f.path);

          const cat = 'ringtones';
          githubPayloads[cat] = [];
          for (const p of ringtonePaths) {
            const parts = p.split('/');
            const filename = parts[1];
            const name = filename.replace('.rtttl', '');
            try {
              const rtttlResp = await fetch(`${GITHUB_RAW}/${repo}/${branch}/${p}`);
              if (!rtttlResp.ok) {
                githubPayloads[cat].push({ name, title: name, description: '', author: '', version: '', path: p, rawUrl: `${GITHUB_RAW}/${repo}/${branch}/${p}` });
                continue;
              }
              const rtttlContent = await rtttlResp.text();
              const rtttlName = rtttlContent.split(':')[0] || name;
              githubPayloads[cat].push({
                name,
                title: rtttlName,
                description: '',
                author: '',
                version: '',
                path: p,
                rawUrl: `${GITHUB_RAW}/${repo}/${branch}/${p}`
              });
            } catch (e) {
              githubPayloads[cat].push({ name, title: name, description: '', author: '', version: '', path: p, rawUrl: `${GITHUB_RAW}/${repo}/${branch}/${p}` });
            }
          }
        } else {
          // Payloads/alerts/recon: look for payload.sh
          const pathRegex = new RegExp('^' + resourcePath.replace(/\//g, '\\/') + '\\/[^/]+\\/[^/]+\\/payload\\.sh$');
          const payloadPaths = treeData.tree
            .filter(f => f.type === 'blob' && f.path.match(pathRegex))
            .map(f => f.path);

          for (const p of payloadPaths) {
            const parts = p.split('/');
            const cat = parts[2];
            const name = parts[3];
            if (name.toLowerCase() === 'nautilus') continue;
            if (!githubPayloads[cat]) githubPayloads[cat] = [];

            try {
              const shResp = await fetch(`${GITHUB_RAW}/${repo}/${branch}/${p}`);
              if (!shResp.ok) {
                githubPayloads[cat].push({ name, title: name, description: '', author: '', version: '', path: p.replace('/payload.sh', ''), rawUrl: `${GITHUB_RAW}/${repo}/${branch}/${p}` });
                continue;
              }
              const shContent = await shResp.text();
              const meta = parsePayloadMeta(shContent);
              githubPayloads[cat].push({
                name,
                title: meta.title || name,
                description: meta.description || '',
                author: meta.author || '',
                version: meta.version || '',
                path: p.replace('/payload.sh', ''),
                rawUrl: `${GITHUB_RAW}/${repo}/${branch}/${p}`
              });
            } catch (e) {
              githubPayloads[cat].push({ name, title: name, description: '', author: '', version: '', path: p.replace('/payload.sh', ''), rawUrl: `${GITHUB_RAW}/${repo}/${branch}/${p}` });
            }
          }
        }

        for (const cat in githubPayloads) {
          if (githubPayloads[cat].length === 0) delete githubPayloads[cat];
        }

        const cacheData = { payloads: githubPayloads, timestamp: Date.now() };
        localStorage.setItem(cacheKey, JSON.stringify(cacheData));
        updateCacheInfo('mergedCacheInfo', cacheData.timestamp);

        filteredGithub = githubPayloads;
        renderGithub();
      } catch (e) {
        console.error('GitHub fetch error:', e);
        const repo = getRepo();
        const is404 = e.message.includes('404');
        if (is404) {
          $('githubCategories').innerHTML = '<div class="empty"><h3>Repository Not Found</h3><p>The GitHub repository <code>' + escHtml(repo) + '</code> does not exist yet.</p><p style="font-size:0.8em;margin-top:8px;color:var(--text2)">Community contributions welcome!</p></div>';
        } else {
          $('githubCategories').innerHTML = '<div class="empty"><h3>Error</h3><p>' + escHtml(e.message) + '</p><p style="font-size:0.8em;margin-top:8px">GitHub API rate limit: 60 requests/hour</p></div>';
        }
      }
      $('refreshMerged').classList.remove('loading');
    }

    function parsePayloadMeta(content) {
      const meta = {};
      const lines = content.split('\n').slice(0, 15);
      for (const line of lines) {
        const m = line.match(/^#\s*(Title|Description|Author|Version):\s*(.+)/i);
        if (m) meta[m[1].toLowerCase()] = m[2].trim();
      }
      return meta;
    }

    function refreshGithubPayloads() {
      localStorage.removeItem(CACHE_KEY_MERGED + '_' + currentResource);
      updateCacheInfo('mergedCacheInfo', null);
      loadGithubPayloads(true);
    }

    async function loadGithubPRs(forceRefresh = false) {
      $('prList').innerHTML = '<div class="github-loading"><img src="nautilus_spinning.png" alt="">Loading pull requests...</div>';
      $('refreshPRs').classList.add('loading');

      const prCacheKey = CACHE_KEY_PRS + '_' + currentResource;

      if (!forceRefresh) {
        try {
          const cached = localStorage.getItem(prCacheKey);
          if (cached) {
            const data = JSON.parse(cached);
            githubPRs = data.prs;
            filteredPRs = githubPRs;
            updateCacheInfo('prsCacheInfo', data.timestamp);
            renderPRs();
            $('refreshPRs').classList.remove('loading');
            return;
          }
        } catch (e) { console.error('Cache read error:', e); }
      }

      try {
        const repo = getRepo();
        const resp = await fetch(`${GITHUB_API}/repos/${repo}/pulls?state=open&per_page=50`);
        if (!resp.ok) throw new Error('GitHub API error: ' + resp.status);
        const prs = await resp.json();

        githubPRs = prs.map(pr => ({
          number: pr.number,
          title: pr.title,
          user: pr.user.login,
          avatar: pr.user.avatar_url,
          url: pr.html_url,
          created: pr.created_at,
          branch: pr.head.ref,
          sha: pr.head.sha,
          forkRepo: pr.head.repo ? pr.head.repo.full_name : repo,
          labels: pr.labels ? pr.labels.map(l => ({ name: l.name, color: l.color })) : []
        }));

        const cacheData = { prs: githubPRs, timestamp: Date.now() };
        localStorage.setItem(prCacheKey, JSON.stringify(cacheData));
        updateCacheInfo('prsCacheInfo', cacheData.timestamp);

        filteredPRs = githubPRs;
        renderPRs();
      } catch (e) {
        console.error('GitHub PR fetch error:', e);
        $('prList').innerHTML = '<div class="empty"><h3>Error</h3><p>' + escHtml(e.message) + '</p></div>';
      }
      $('refreshPRs').classList.remove('loading');
    }

    function refreshGithubPRs() {
      localStorage.removeItem(CACHE_KEY_PRS + '_' + currentResource);
      localStorage.removeItem(CACHE_KEY_PR_FILES + '_' + currentResource);
      updateCacheInfo('prsCacheInfo', null);
      loadGithubPRs(true);
    }

    function renderGithub() {
      const resLabel = currentResource.charAt(0).toUpperCase() + currentResource.slice(1);
      if (Object.keys(filteredGithub).length === 0) {
        $('githubCategories').innerHTML = '<div class="empty"><h3>No ' + resLabel + '</h3><p>No GitHub ' + resLabel.toLowerCase() + ' found</p></div>';
        return;
      }
      let html = '';
      for (const [cat, list] of Object.entries(filteredGithub).sort((a, b) => a[0].localeCompare(b[0]))) {
        html += '<div class="category"><div class="cat-header" onclick="toggle(this)"><span>' + escHtml(cat) + '</span><span style="display:flex;align-items:center;gap:8px"><span class="count">' + list.length + '</span><span class="arrow"></span></span></div><div class="payloads">';
        for (const p of list) {
          html += '<div class="payload" data-github-path="' + escHtml(p.path) + '" onclick="selectGithubPayload(\'' + escHtml(p.path) + '\')"><div class="name">' + escHtml(p.title) + '</div><div class="desc">' + escHtml(p.description || 'No description') + '</div></div>';
        }
        html += '</div></div>';
      }
      $('githubCategories').innerHTML = html;
    }

    function renderPRs() {
      if (filteredPRs.length === 0) {
        $('prList').innerHTML = '<div class="empty"><h3>No Pull Requests</h3><p>No open PRs found</p></div>';
        return;
      }
      let html = '';
      for (const pr of filteredPRs) {
        const date = new Date(pr.created).toLocaleDateString();
        let labelsHtml = '';
        if (pr.labels && pr.labels.length > 0) {
          labelsHtml = '<div class="pr-labels">';
          for (const label of pr.labels) {
            const bgColor = '#' + label.color;
            const textColor = getLabelTextColor(label.color);
            labelsHtml += '<span class="pr-label" style="background:' + bgColor + ';color:' + textColor + '">' + escHtml(label.name) + '</span>';
          }
          labelsHtml += '</div>';
        }
        html += '<div class="pr-item" onclick="selectPR(' + pr.number + ')"><div class="pr-title"><span class="pr-number">#' + pr.number + '</span> ' + escHtml(pr.title) + '</div>' + labelsHtml + '<div class="pr-meta">by ' + escHtml(pr.user) + '  ' + date + '</div></div>';
      }
      $('prList').innerHTML = html;
    }

    function getLabelTextColor(hexColor) {
      const r = parseInt(hexColor.substr(0, 2), 16);
      const g = parseInt(hexColor.substr(2, 2), 16);
      const b = parseInt(hexColor.substr(4, 2), 16);
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      return luminance > 0.5 ? '#000' : '#fff';
    }

    function selectGithubPayload(path) {
      if (running && runningSection !== 'merged') stop();
      hideSource();
      document.querySelectorAll('.payload').forEach(p => p.classList.remove('active'));
      const el = document.querySelector('.payload[data-github-path="' + path + '"]');
      if (el) el.classList.add('active');
      for (const cat in githubPayloads) {
        const found = githubPayloads[cat].find(p => p.path === path);
        if (found) {
          selected = { ...found, isGithub: true };
          const authorHtml = found.author ? '<span><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>' + escHtml(found.author) + '</span>' : '';
          const versionHtml = found.version ? '<span><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>v' + escHtml(found.version) + '</span>' : '';
          const repo = getRepo();
          const ghUrl = 'https://github.com/' + repo + '/tree/' + getBranch() + '/' + found.path;
          const favActive = isFavourite(found.path, 'merged') ? 'active' : '';
          $('detail').innerHTML = '<div style="display:flex;align-items:center;justify-content:space-between"><h2>' + escHtml(found.title) + '</h2><button class="fav-btn ' + favActive + '" id="favBtn" onclick="toggleFavourite(\'' + escHtml(found.path) + '\',\'merged\',\'' + escHtml(found.title) + '\')" title="' + (favActive ? 'Remove from Favourites' : 'Add to Favourites') + '"><svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></button></div><div class="meta">' + authorHtml + versionHtml + '<span><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>GitHub</span></div><div class="description">' + escHtml(found.description || 'No description') + '</div><a href="' + ghUrl + '" target="_blank" class="btn secondary" style="width:100%;margin-bottom:8px"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>View on GitHub</a><div class="actions"><div class="btn-row"><button class="btn" id="runBtn" onclick="runGithub()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M8 5v14l11-7z"/></svg><span id="runBtnText">Run Payload</span></button><button class="btn secondary" id="sourceBtn" onclick="toggleSource()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg><span id="sourceBtnText">View Source</span></button></div><button class="btn secondary btn-half" id="installBtn" onclick="installGithub()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>Install Locally</button></div>';
          updateRunBtn();
          updateInstallBtn();
          break;
        }
      }
    }

    function selectPR(number) {
      if (running && runningSection !== 'pr') stop();
      hideSource();
      const pr = githubPRs.find(p => p.number === number);
      if (!pr) return;
      selected = { ...pr, isPR: true };
      const loadBtnLabel = currentResource === 'ringtones' ? 'Load Ringtones' : 'Load Payloads';
      $('detail').innerHTML = '<h2><span style="color:var(--accent)">#' + pr.number + '</span> ' + escHtml(pr.title) + '</h2><div class="meta"><span><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>' + escHtml(pr.user) + '</span><span><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>' + escHtml(pr.branch) + '</span></div><div class="description">Pull Request from ' + escHtml(pr.user) + '</div><a href="' + escHtml(pr.url) + '" target="_blank" class="btn secondary" style="width:100%;margin-bottom:8px"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>View on GitHub</a><button class="btn" style="width:100%" onclick="loadPRPayloads(' + pr.number + ')"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>' + loadBtnLabel + '</button>';
    }

    function getPRFilesCache() {
      try { return JSON.parse(localStorage.getItem(CACHE_KEY_PR_FILES) || '{}'); }
      catch (e) { return {}; }
    }

    function setPRFilesCache(number, files) {
      const cache = getPRFilesCache();
      cache[number] = { files, timestamp: Date.now() };
      localStorage.setItem(CACHE_KEY_PR_FILES, JSON.stringify(cache));
    }

    async function loadPRPayloads(number) {
      const pr = githubPRs.find(p => p.number === number);
      if (!pr) return;
      $('console').innerHTML = '';
      lineCount = 0;
      $('lineCount').textContent = '0 lines';
      $('detail').innerHTML += '<div class="github-loading" style="margin-top:16px"><img src="nautilus_spinning.png" alt="">Loading PR files...</div>';

      let prFiles = [];
      const cache = getPRFilesCache();
      const repo = getRepo();

      // Determine file filter based on resource type
      const isRingtones = currentResource === 'ringtones';
      const isThemes = currentResource === 'themes';
      const fileFilter = isRingtones ? f => f.filename.endsWith('.rtttl') : 
                         isThemes ? f => f.filename.endsWith('theme.json') : 
                         f => f.filename.endsWith('payload.sh');
      const itemLabel = isRingtones ? 'Ringtones' : isThemes ? 'Themes' : 'Payloads';
      const noFilesMsg = isRingtones ? '[GitHub] No .rtttl files found in this PR' : 
                         isThemes ? '[GitHub] No theme.json files found in this PR' :
                         '[GitHub] No payload.sh files found in this PR';
      const structureMsg = isRingtones ? 'PRs must follow the structure: ringtones/<name>.rtttl' : 
                           isThemes ? 'PRs must follow the structure: themes/<name>/theme.json' :
                           'PRs must follow the structure: library/user/category/name/payload.sh';

      // Cache key includes resource type to avoid serving wrong cached data
      const cacheKey = `${number}_${currentResource}`;
      if (cache[cacheKey]) {
        prFiles = cache[cacheKey].files;
      } else {
        try {
          const resp = await fetch(`${GITHUB_API}/repos/${repo}/pulls/${number}/files`);
          if (!resp.ok) throw new Error('API error');
          const files = await resp.json();
          prFiles = files.filter(fileFilter).map(f => ({ filename: f.filename, sha: f.sha }));
          cache[cacheKey] = { files: prFiles, timestamp: Date.now() };
          localStorage.setItem(CACHE_KEY_PR_FILES, JSON.stringify(cache));
        } catch (e) {
          $('detail').querySelector('.github-loading')?.remove();
          $('detail').innerHTML += '<p style="color:var(--danger);margin-top:12px">Error loading PR files</p>';
          return;
        }
      }

      $('detail').querySelector('.github-loading')?.remove();

      if (prFiles.length === 0) {
        $('console').innerHTML = '';
        lineCount = 0;
        const line = document.createElement('div');
        line.className = 'line yellow';
        line.textContent = noFilesMsg;
        $('console').appendChild(line);
        lineCount++;
        const line2 = document.createElement('div');
        line2.className = 'line';
        line2.textContent = structureMsg;
        $('console').appendChild(line2);
        lineCount++;
        $('lineCount').textContent = lineCount + ' lines';
        return;
      }
      const forkRepo = pr.forkRepo || repo;
      let html = '<div style="margin-top:16px"><h3 style="font-size:0.9em;color:var(--text2);margin-bottom:8px">' + itemLabel + ' in this PR:</h3>';
      for (const f of prFiles) {
        const name = isRingtones ? f.filename.replace(/^ringtones\//, '').replace('.rtttl', '') : 
                     isThemes ? f.filename.split('/').slice(-2, -1)[0] || f.filename.replace('/theme.json', '') :
                     (f.filename.split('/').slice(-2, -1)[0] || f.filename);
        html += '<div class="payload pr-payload" data-pr-sha="' + escHtml(pr.sha) + '" data-pr-file="' + escHtml(f.filename) + '" style="margin:4px 0" onclick="selectPRPayload(this,\'' + escHtml(pr.sha) + '\',\'' + escHtml(f.filename) + '\',\'' + escHtml(name) + '\',\'' + escHtml(forkRepo) + '\')"><div class="name">' + escHtml(name) + '</div><div class="desc">' + escHtml(f.filename) + '</div></div>';
      }
      const runBtnLabel = isRingtones ? 'Play Ringtone' : isThemes ? 'Apply Theme' : 'Run Payload';
      html += '</div><div id="prPayloadActions" style="display:none;margin-top:12px"><div class="btn-row"><button class="btn" id="runBtn" onclick="runSelectedPRPayload()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M8 5v14l11-7z"/></svg><span id="runBtnText">' + runBtnLabel + '</span></button><button class="btn secondary" id="sourceBtn" onclick="togglePRSource()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg><span id="prSourceBtnText">View Source</span></button></div><button class="btn secondary btn-half" id="installPRBtn" onclick="installSelectedPRPayload()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>Install Locally</button></div>';
      $('detail').innerHTML += html;
      updateRunBtn();
    }

    async function runGithub() {
      if (!selected || !selected.isGithub) return;
      if (running) { stop(); return; }
      hideSource();
      running = true; runningSection = 'merged'; lineCount = 0;
      updateRunBtn();
      $('console').innerHTML = '';
      $('lineCount').textContent = '0 lines';
      $('status').textContent = 'Running GitHub payload...';
      $('status').classList.add('running');

      let token = '';
      try {
        const tokenResp = await fetch('/cgi-bin/api.sh?action=token');
        const tokenData = await tokenResp.json();
        if (tokenData.code === 'AUTH_REQUIRED') {
          running = false; runningSection = null; updateRunBtn();
          $('status').textContent = 'Session expired'; $('status').classList.remove('running');
          showLogin(); return;
        }
        token = tokenData.token || '';
      } catch (e) {
        console.error('Failed to get CSRF token:', e);
        $('status').textContent = 'Security error: Could not get token';
        running = false;
        updateRunBtn();
        return;
      }

      evtSource = new EventSource(`/cgi-bin/api.sh?action=run_github&github_url=${encodeURIComponent(selected.rawUrl)}&token=${encodeURIComponent(token)}`);
      evtSource.onmessage = e => {
        try {
          const d = JSON.parse(e.data);
          const text = d.text.replace(/\\n/g, '\n').replace(/\\\\n/g, '\n');
          const lines = text.split('\n');
          lines.forEach(t => {
            if (t.trim() === '') return;
            const line = document.createElement('div');
            line.className = 'line ' + (d.color || '');
            line.textContent = t;
            $('console').appendChild(line);
            lineCount++;
          });
          $('lineCount').textContent = lineCount + ' lines';
          $('console').scrollTop = $('console').scrollHeight;
        } catch (err) { }
      };
      evtSource.addEventListener('prompt', e => {
        try { const d = JSON.parse(e.data); showPrompt(d.type, d.message, d.default || ''); } catch (err) { }
      });
      evtSource.addEventListener('spinner', e => {
        try { const d = JSON.parse(e.data); handleSpinner(d); } catch (err) { }
      });
      evtSource.addEventListener('button_wait', e => {
        try { const d = JSON.parse(e.data); handleButtonWait(d); } catch (err) { }
      });
      evtSource.addEventListener('done', () => {
        evtSource.close();
        running = false;
        hideSpinner();
        hideButtonPanel();
        updateRunBtn();
        $('status').textContent = 'Complete';
        $('status').classList.remove('running');
      });
      evtSource.onerror = () => {
        evtSource.close();
        running = false;
        hideButtonPanel();
        hideSpinner();
        updateRunBtn();
        $('status').textContent = 'Connection lost';
        $('status').classList.remove('running');
      };
    }

    let selectedPRPayload = null;

    function selectPRPayload(el, sha, filename, name, forkRepo) {
      hideSource();
      document.querySelectorAll('.pr-payload').forEach(p => p.classList.remove('active'));
      el.classList.add('active');
      const repo = getRepo();
      selectedPRPayload = { sha, filename, name, forkRepo: forkRepo || repo };
      const actions = $('prPayloadActions');
      if (actions) actions.style.display = 'block';
      updateRunBtn();
    }

    function runSelectedPRPayload() {
      if (!selectedPRPayload) return;
      runPRPayload(selectedPRPayload.sha, selectedPRPayload.filename, selectedPRPayload.forkRepo);
    }

    function installSelectedPRPayload() {
      if (!selectedPRPayload) return;
      installPRPayload(selectedPRPayload.sha, selectedPRPayload.filename, selectedPRPayload.name, selectedPRPayload.forkRepo);
    }

    async function togglePRSource() {
      if (!selectedPRPayload) return;

      if (viewingSource) {
        hideSource();
        const btn = $('prSourceBtnText');
        if (btn) btn.textContent = 'View Source';
        return;
      }

      const repo = getRepo();
      const fork = selectedPRPayload.forkRepo || repo;
      const rawUrl = `${GITHUB_RAW}/${fork}/${selectedPRPayload.sha}/${selectedPRPayload.filename}`;

      $('consoleTitle').textContent = 'Loading source...';

      try {
        const resp = await fetch(rawUrl);
        if (!resp.ok) throw new Error('Failed to fetch from GitHub');
        const content = await resp.text();

        const lines = content.split('\n');
        let html = '<table>';
        for (let i = 0; i < lines.length; i++) {
          const lineNum = i + 1;
          const highlighted = highlightSh(lines[i]);
          html += '<tr><td class="line-num">' + lineNum + '</td><td class="line-code">' + highlighted + '</td></tr>';
        }
        html += '</table>';

        $('sourceViewer').innerHTML = html;
        $('sourceViewer').style.display = '';
        $('console').style.display = 'none';
        $('consoleTitle').textContent = 'Source: ' + selectedPRPayload.name;
        viewingSource = true;

        const btn = $('prSourceBtnText');
        if (btn) btn.textContent = 'Hide Source';
      } catch (e) {
        $('consoleTitle').textContent = 'Nautilus Console';
        const line = document.createElement('div');
        line.className = 'line red';
        line.textContent = '[Source] Error: ' + e.message;
        $('console').appendChild(line);
        lineCount++;
        $('lineCount').textContent = lineCount + ' lines';
      }
    }

    async function runPRPayload(sha, filename, forkRepo) {
      if (running) { stop(); return; }
      hideSource();
      running = true; runningSection = 'pr'; lineCount = 0;
      updateRunBtn();
      $('console').innerHTML = '';
      $('lineCount').textContent = '0 lines';
      $('status').textContent = 'Running PR payload...';
      $('status').classList.add('running');

      const repo = getRepo();
      const finalRepo = forkRepo || repo;
      const rawUrl = `${GITHUB_RAW}/${finalRepo}/${sha}/${filename}`;

      let token = '';
      try {
        const tokenResp = await fetch('/cgi-bin/api.sh?action=token');
        const tokenData = await tokenResp.json();
        if (tokenData.code === 'AUTH_REQUIRED') {
          running = false; runningSection = null; updateRunBtn();
          $('status').textContent = 'Session expired'; $('status').classList.remove('running');
          showLogin(); return;
        }
        token = tokenData.token || '';
        if (!token) {
          console.error('Empty token received:', tokenData);
          $('status').textContent = 'Security error: Empty token';
          running = false;
          updateRunBtn();
          return;
        }
      } catch (e) {
        console.error('Failed to get CSRF token:', e);
        $('status').textContent = 'Security error: Could not get token';
        running = false;
        updateRunBtn();
        return;
      }

      evtSource = new EventSource(`/cgi-bin/api.sh?action=run_github&github_url=${encodeURIComponent(rawUrl)}&token=${encodeURIComponent(token)}`);
      evtSource.onmessage = e => {
        try {
          const d = JSON.parse(e.data);
          const text = d.text.replace(/\\n/g, '\n').replace(/\\\\n/g, '\n');
          const lines = text.split('\n');
          lines.forEach(t => {
            if (t.trim() === '') return;
            const line = document.createElement('div');
            line.className = 'line ' + (d.color || '');
            line.textContent = t;
            $('console').appendChild(line);
            lineCount++;
          });
          $('lineCount').textContent = lineCount + ' lines';
          $('console').scrollTop = $('console').scrollHeight;
        } catch (err) { }
      };
      evtSource.addEventListener('prompt', e => {
        try { const d = JSON.parse(e.data); showPrompt(d.type, d.message, d.default || ''); } catch (err) { }
      });
      evtSource.addEventListener('spinner', e => {
        try { const d = JSON.parse(e.data); handleSpinner(d); } catch (err) { }
      });
      evtSource.addEventListener('button_wait', e => {
        try { const d = JSON.parse(e.data); handleButtonWait(d); } catch (err) { }
      });
      evtSource.addEventListener('done', () => {
        evtSource.close();
        running = false;
        hideSpinner();
        hideButtonPanel();
        updateRunBtn();
        $('status').textContent = 'Complete';
        $('status').classList.remove('running');
      });
      evtSource.onerror = () => {
        evtSource.close();
        running = false;
        hideSpinner();
        hideButtonPanel();
        updateRunBtn();
        $('status').textContent = 'Connection lost';
        $('status').classList.remove('running');
      };
    }

    let installing = false;
    let installEvtSource = null;

    function updateInstallBtn() {
      const btn = $('installBtn');
      if (!btn) return;
      if (installing) {
        btn.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M6 6h12v12H6z"/></svg>Cancel Install';
        btn.classList.remove('secondary');
        btn.classList.add('stop');
      } else {
        btn.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>Install Locally';
        btn.classList.add('secondary');
        btn.classList.remove('stop');
      }
    }

    function stopInstall() {
      if (installEvtSource) { installEvtSource.close(); installEvtSource = null; }
      installing = false;
      updateInstallBtn();
      $('status').textContent = 'Install cancelled';
      $('status').classList.remove('running');
      fetch('/cgi-bin/api.sh?action=stop').catch(() => { });
      const line = document.createElement('div');
      line.className = 'line red';
      line.textContent = '[Install] Cancelled - partial files cleaned up';
      $('console').appendChild(line);
      lineCount++;
      $('lineCount').textContent = lineCount + ' lines';
      $('console').scrollTop = $('console').scrollHeight;
    }

    async function installGithub(forceOverwrite = false) {
      if (!selected || !selected.isGithub) return;
      if (installing) { stopInstall(); return; }
      if (running) { stop(); }

      installing = true; lineCount = 0;
      updateInstallBtn();
      $('console').innerHTML = '';
      $('lineCount').textContent = '0 lines';
      $('status').textContent = 'Installing payload...';
      $('status').classList.add('running');

      let token = '';
      try {
        const tokenResp = await fetch('/cgi-bin/api.sh?action=token');
        const tokenData = await tokenResp.json();
        if (tokenData.code === 'AUTH_REQUIRED') {
          installing = false; updateInstallBtn();
          $('status').textContent = 'Session expired'; $('status').classList.remove('running');
          showLogin(); return;
        }
        token = tokenData.token || '';
      } catch (e) {
        console.error('Failed to get CSRF token:', e);
        $('status').textContent = 'Security error: Could not get token';
        installing = false;
        updateInstallBtn();
        return;
      }

      const forceParam = forceOverwrite ? '&force=1' : '';
      installEvtSource = new EventSource(`/cgi-bin/api.sh?action=install_github&github_url=${encodeURIComponent(selected.rawUrl)}&token=${encodeURIComponent(token)}${forceParam}`);

      installEvtSource.onmessage = e => {
        try {
          const d = JSON.parse(e.data);
          const text = d.text.replace(/\\n/g, '\n').replace(/\\\\n/g, '\n');
          const lines = text.split('\n');
          lines.forEach(t => {
            if (t.trim() === '') return;
            const line = document.createElement('div');
            line.className = 'line ' + (d.color || '');
            line.textContent = t;
            $('console').appendChild(line);
            lineCount++;
          });
          $('lineCount').textContent = lineCount + ' lines';
          $('console').scrollTop = $('console').scrollHeight;
        } catch (err) { }
      };

      installEvtSource.addEventListener('exists', async e => {
        installEvtSource.close();
        installing = false;
        updateInstallBtn();
        $('status').textContent = 'Payload exists';
        $('status').classList.remove('running');

        showInstallConfirm();
      });

      installEvtSource.addEventListener('done', e => {
        installEvtSource.close();
        installing = false;
        updateInstallBtn();
        try {
          const d = JSON.parse(e.data);
          if (d.status === 'success') {
            $('status').textContent = 'Installed: ' + d.name;
            load();
          } else {
            $('status').textContent = 'Install failed: ' + (d.message || 'Unknown error');
          }
        } catch (err) {
          $('status').textContent = 'Install complete';
        }
        $('status').classList.remove('running');
      });

      installEvtSource.onerror = () => {
        installEvtSource.close();
        installing = false;
        updateInstallBtn();
        $('status').textContent = 'Install connection lost';
        $('status').classList.remove('running');
      };
    }

    let pendingPRInstall = null;

    function showInstallConfirm(isPR = false) {
      $('modalTitle').textContent = 'Overwrite Existing?';
      $('modalMessage').innerHTML = 'This payload is already installed locally.<br><br>Do you want to <strong>delete the existing version</strong> and install the new one from GitHub?';
      $('modalInput').style.display = 'none';
      $('modalConfirm').textContent = 'Yes, Overwrite';
      $('modalCancel').textContent = 'Cancel';
      $('modalCancel').style.display = '';
      $('modalTitle').style.color = '#ffd93d';
      $('modalOverlay').classList.add('show');

      $('modalConfirm').onclick = () => {
        $('modalOverlay').classList.remove('show');
        $('modalConfirm').onclick = () => respondPrompt(true);
        if (isPR && pendingPRInstall) {
          installPRPayload(pendingPRInstall.sha, pendingPRInstall.filename, pendingPRInstall.name, pendingPRInstall.forkRepo, true);
          pendingPRInstall = null;
        } else {
          installGithub(true);
        }
      };
      $('modalCancel').onclick = () => {
        $('modalOverlay').classList.remove('show');
        $('modalCancel').onclick = () => respondPrompt(false);
        pendingPRInstall = null;
        const line = document.createElement('div');
        line.className = 'line yellow';
        line.textContent = '[Install] Cancelled - existing payload preserved';
        $('console').appendChild(line);
        lineCount++;
        $('lineCount').textContent = lineCount + ' lines';
      };
    }

    async function installPRPayload(sha, filename, name, forkRepo, forceOverwrite = false) {
      if (installing) { stopInstall(); return; }
      if (running) { stop(); }

      installing = true; lineCount = 0;
      updateInstallPRBtn();
      $('console').innerHTML = '';
      $('lineCount').textContent = '0 lines';
      $('status').textContent = 'Installing PR payload...';
      $('status').classList.add('running');

      let token = '';
      try {
        const tokenResp = await fetch('/cgi-bin/api.sh?action=token');
        const tokenData = await tokenResp.json();
        if (tokenData.code === 'AUTH_REQUIRED') {
          installing = false; updateInstallPRBtn();
          $('status').textContent = 'Session expired'; $('status').classList.remove('running');
          showLogin(); return;
        }
        token = tokenData.token || '';
      } catch (e) {
        console.error('Failed to get CSRF token:', e);
        $('status').textContent = 'Security error: Could not get token';
        installing = false;
        updateInstallPRBtn();
        return;
      }

      const repo = forkRepo || getRepo();
      const rawUrl = `${GITHUB_RAW}/${repo}/${sha}/${filename}`;
      const forceParam = forceOverwrite ? '&force=1' : '';

      pendingPRInstall = { sha, filename, name, forkRepo };

      installEvtSource = new EventSource(`/cgi-bin/api.sh?action=install_pr&github_url=${encodeURIComponent(rawUrl)}&pr_path=${encodeURIComponent(filename)}&token=${encodeURIComponent(token)}${forceParam}`);

      installEvtSource.onmessage = e => {
        try {
          const d = JSON.parse(e.data);
          const text = d.text.replace(/\\n/g, '\n').replace(/\\\\n/g, '\n');
          const lines = text.split('\n');
          lines.forEach(t => {
            if (t.trim() === '') return;
            const line = document.createElement('div');
            line.className = 'line ' + (d.color || '');
            line.textContent = t;
            $('console').appendChild(line);
            lineCount++;
          });
          $('lineCount').textContent = lineCount + ' lines';
          $('console').scrollTop = $('console').scrollHeight;
        } catch (err) { }
      };

      installEvtSource.addEventListener('exists', async e => {
        installEvtSource.close();
        installing = false;
        updateInstallPRBtn();
        $('status').textContent = 'Payload exists';
        $('status').classList.remove('running');
        showInstallConfirm(true);
      });

      installEvtSource.addEventListener('done', e => {
        installEvtSource.close();
        installing = false;
        pendingPRInstall = null;
        updateInstallPRBtn();
        try {
          const d = JSON.parse(e.data);
          if (d.status === 'success') {
            $('status').textContent = 'Installed: ' + d.name;
            load();
          } else {
            $('status').textContent = 'Install failed: ' + (d.message || 'Unknown error');
          }
        } catch (err) {
          $('status').textContent = 'Install complete';
        }
        $('status').classList.remove('running');
      });

      installEvtSource.onerror = () => {
        installEvtSource.close();
        installing = false;
        pendingPRInstall = null;
        updateInstallPRBtn();
        $('status').textContent = 'Install connection lost';
        $('status').classList.remove('running');
      };
    }

    function updateInstallPRBtn() {
      const btn = $('installPRBtn');
      if (!btn) return;
      if (installing) {
        btn.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M6 6h12v12H6z"/></svg>Cancel Install';
        btn.classList.remove('secondary');
        btn.classList.add('stop');
      } else {
        btn.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>Install Locally';
        btn.classList.add('secondary');
        btn.classList.remove('stop');
      }
    }

    function sha256(s) {
      const K = [0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5, 0x3956c25b, 0x59f111f1, 0x923f82a4, 0xab1c5ed5, 0xd807aa98, 0x12835b01, 0x243185be, 0x550c7dc3, 0x72be5d74, 0x80deb1fe, 0x9bdc06a7, 0xc19bf174, 0xe49b69c1, 0xefbe4786, 0x0fc19dc6, 0x240ca1cc, 0x2de92c6f, 0x4a7484aa, 0x5cb0a9dc, 0x76f988da, 0x983e5152, 0xa831c66d, 0xb00327c8, 0xbf597fc7, 0xc6e00bf3, 0xd5a79147, 0x06ca6351, 0x14292967, 0x27b70a85, 0x2e1b2138, 0x4d2c6dfc, 0x53380d13, 0x650a7354, 0x766a0abb, 0x81c2c92e, 0x92722c85, 0xa2bfe8a1, 0xa81a664b, 0xc24b8b70, 0xc76c51a3, 0xd192e819, 0xd6990624, 0xf40e3585, 0x106aa070, 0x19a4c116, 0x1e376c08, 0x2748774c, 0x34b0bcb5, 0x391c0cb3, 0x4ed8aa4a, 0x5b9cca4f, 0x682e6ff3, 0x748f82ee, 0x78a5636f, 0x84c87814, 0x8cc70208, 0x90befffa, 0xa4506ceb, 0xbef9a3f7, 0xc67178f2];
      function rr(n, x) { return (x >>> n) | (x << (32 - n)); }
      let H = [0x6a09e667, 0xbb67ae85, 0x3c6ef372, 0xa54ff53a, 0x510e527f, 0x9b05688c, 0x1f83d9ab, 0x5be0cd19];
      const b = new TextEncoder().encode(s); const l = b.length * 8;
      const ml = Math.ceil((l + 65) / 512) * 64; const m = new Uint8Array(ml);
      m.set(b); m[b.length] = 0x80; const dv = new DataView(m.buffer);
      dv.setUint32(ml - 4, l, false);
      for (let o = 0; o < ml; o += 64) {
        const w = new Uint32Array(64);
        for (let i = 0; i < 16; i++)w[i] = dv.getUint32(o + i * 4, false);
        for (let i = 16; i < 64; i++) {
          const s0 = rr(7, w[i - 15]) ^ rr(18, w[i - 15]) ^ (w[i - 15] >>> 3);
          const s1 = rr(17, w[i - 2]) ^ rr(19, w[i - 2]) ^ (w[i - 2] >>> 10);
          w[i] = (w[i - 16] + s0 + w[i - 7] + s1) >>> 0;
        }
        let [a, b, c, d, e, f, g, h] = H;
        for (let i = 0; i < 64; i++) {
          const S1 = rr(6, e) ^ rr(11, e) ^ rr(25, e);
          const ch = (e & f) ^ ((~e) & g);
          const t1 = (h + S1 + ch + K[i] + w[i]) >>> 0;
          const S0 = rr(2, a) ^ rr(13, a) ^ rr(22, a);
          const mj = (a & b) ^ (a & c) ^ (b & c);
          const t2 = (S0 + mj) >>> 0;
          h = g; g = f; f = e; e = (d + t1) >>> 0; d = c; c = b; b = a; a = (t1 + t2) >>> 0;
        }
        H = [(H[0] + a) >>> 0, (H[1] + b) >>> 0, (H[2] + c) >>> 0, (H[3] + d) >>> 0, (H[4] + e) >>> 0, (H[5] + f) >>> 0, (H[6] + g) >>> 0, (H[7] + h) >>> 0];
      }
      return H.map(x => x.toString(16).padStart(8, '0')).join('');
    }

    async function checkSession() {
      try {
        const r = await fetch('/cgi-bin/api.sh?action=check_session');
        const d = await r.json();
        return d.authenticated === true;
      } catch (e) { return false; }
    }

    async function doLogin() {
      const pw = $('loginPassword').value;
      if (!pw) { $('loginError').classList.add('show'); $('loginError').textContent = 'Enter password'; return; }
      $('loginError').classList.remove('show');
      try {
        const cr = await fetch('/cgi-bin/api.sh?action=challenge');
        const cd = await cr.json();
        if (!cd.challenge) throw new Error('No challenge');
        const nonce = cd.challenge;
        const keyHex = sha256(nonce);
        const keyBytes = new Uint8Array(keyHex.match(/.{2}/g).map(b => parseInt(b, 16)));
        const pwBytes = new TextEncoder().encode(pw);
        const encrypted = new Uint8Array(pwBytes.length);
        for (let i = 0; i < pwBytes.length; i++)encrypted[i] = pwBytes[i] ^ keyBytes[i % keyBytes.length];
        const b64 = btoa(String.fromCharCode(...encrypted));
        const ar = await fetch('/cgi-bin/api.sh?action=auth&nonce=' + encodeURIComponent(nonce) + '&data=' + encodeURIComponent(b64));
        const ad = await ar.json();
        if (ad.success) {
          $('loginOverlay').classList.add('hidden');

          // Set Pineapple Auth Cookie if token provided (allows connecting to Pager on port 1471)
          if (ad.pineapple_token) {
            try {
              const decoded = JSON.parse(atob(ad.pineapple_token.split('.')[0]));
              const serverid = decoded.ServerId;
              // Set cookie for the main domain (which covers both ports)
              document.cookie = `AUTH_${serverid}=${ad.pineapple_token};path=/;samesite=strict;max-age=${60 * 60 * 12}`;
              console.log("Set Pineapple Auth Cookie for ServerID: " + serverid);
            } catch (err) {
              console.error("Failed to set Pineapple cookie:", err);
            }
          }

          load();
          setTimeout(() => { connectShell(); connectPager(); }, 500);
        }
        else { $('loginError').textContent = ad.error || 'Invalid password'; $('loginError').classList.add('show'); }
      } catch (e) { $('loginError').textContent = 'Auth error: ' + e.message; $('loginError').classList.add('show'); }
    }

    function showLogin() {
      $('loginOverlay').classList.remove('hidden');
      $('loginPassword').value = '';
      $('loginPassword').focus();
      $('loginError').classList.remove('show');
    }

    async function initAuth() {
      if (await checkSession()) { $('loginOverlay').classList.add('hidden'); load(); setTimeout(() => { connectShell(); connectPager(); }, 500); }
      else { showLogin(); }
    }

    async function load() {
      // If we are on the local tab, load the current resource live
      if (currentTab === 'local') {
        if (currentResource === 'loot') {
          await loadLootLive();
        } else {
          await loadLocalResourceLive(currentResource);
        }
      } else {
        try {
          const r = await fetch('/cgi-bin/api.sh?action=list');
          if (!r.ok) throw new Error('HTTP ' + r.status);
          const text = await r.text();
          allData = JSON.parse(text);
          // Handle both old format (flat) and new format (nested by resource type)
          if (!allData.payloads && !allData.alerts && !allData.recon && !allData.themes && !allData.ringtones) {
            // Old format compatibility - treat as payloads
            allData = { payloads: allData, alerts: {}, recon: {}, themes: {}, ringtones: {} };
          }
        } catch (e) {
          console.error(e);
        }
      }
      
      loadWifiStatus();
      loadFavourites();
    }

    function render() {
      let html = '';
      const cats = Object.keys(filtered).sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
      cats.forEach(cat => {
        const items = filtered[cat];
        if (!items || !items.length) return;
        const sorted = [...items].sort((a, b) => (a.name || '').toLowerCase().localeCompare((b.name || '').toLowerCase()));
        html += `<div class="category"><div class="cat-header" onclick="toggle(this)"><span>${escHtml(cat)}</span><span style="display:flex;align-items:center;gap:8px"><span class="count">${items.length}</span><span class="arrow"></span></span></div><div class="payloads">`;
        sorted.forEach((p, i) => {
          const name = escHtml(p.name || '');
          const desc = escHtml(p.desc || '');
          const disabledClass = p.disabled ? ' disabled' : '';
          const disabledBadge = p.disabled ? '<span class="disabled-badge">DISABLED</span>' : '';
          html += `<div class="payload${disabledClass}" data-path="${p.path}" onclick="selectByPath('${p.path}')"><div class="name">${name}${disabledBadge}</div><div class="desc">${desc}</div></div>`;
        });
        html += `</div></div>`;
      });
      $('categories').innerHTML = html || '<div class="empty"><p>No payloads found</p></div>';
    }

    function escHtml(s) { return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }

    function filter(q) {
      q = q.toLowerCase().trim();
      if (!q) { filtered = payloads; render(); return; }
      filtered = {};
      for (const cat in payloads) {
        const matches = payloads[cat].filter(p => (p.name + ' ' + p.desc + ' ' + p.author).toLowerCase().includes(q));
        if (matches.length) filtered[cat] = matches;
      }
      render();
    }

    function toggle(el) { el.classList.toggle('open'); el.nextElementSibling.classList.toggle('open'); }

    function renderDetail() {
      if (!selected) {
        $('detail').innerHTML = '<div class="empty"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg><h3>Select a Payload</h3><p>Choose from the sidebar</p></div>';
      }
    }

    function selectByPath(path) {
      if (running && runningSection !== 'local') stop();
      hideSource();
      document.querySelectorAll('.payload').forEach(p => p.classList.remove('active'));
      const el = document.querySelector('.payload[data-path="' + path + '"]');
      if (el) el.classList.add('active');
      for (const cat in payloads) {
        const found = payloads[cat].find(p => p.path === path);
        if (found) {
          selected = found;
          const author = selected.author ? escHtml(selected.author) : '';
          const desc = selected.desc ? escHtml(selected.desc) : '';
          const authorHtml = author ? '<span><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>' + author + '</span>' : '';
          const descHtml = desc ? '<div class="description">' + desc + '</div>' : '';

          // Loot files have download/delete buttons instead of run/source
          if (currentResource === 'loot') {
            const sizeStr = selected.size ? formatFileSize(selected.size) : '';
            const sizeHtml = sizeStr ? '<span><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-1 9h-2v6h2v-6zm0-4h-2v2h2V7z"/></svg>' + sizeStr + '</span>' : '';
            $('detail').innerHTML = '<h2>' + escHtml(selected.name) + '</h2><div class="meta"><span><svg viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg>' + cat + '</span>' + sizeHtml + '</div>' + descHtml + '<div class="actions"><div class="btn-row"><button class="btn" onclick="downloadLoot()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>Download</button><button class="btn secondary" onclick="viewLootContent()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>View</button></div><button class="btn secondary btn-half" style="background:var(--danger);border-color:var(--danger)" onclick="deleteLoot()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>Delete</button></div>';
          } else {
            const isNautilus = selected.path.includes('/remote_access/nautilus/');
            const deleteRow = isNautilus ? '' : '<button class="btn secondary btn-half" id="deleteBtn" onclick="deletePayload()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>Delete</button>';
            const favActive = isFavourite(selected.path, 'local') ? 'active' : '';
            $('detail').innerHTML = '<div style="display:flex;align-items:center;justify-content:space-between"><h2>' + escHtml(selected.name) + '</h2><button class="fav-btn ' + favActive + '" id="favBtn" onclick="toggleFavourite(\'' + escHtml(selected.path) + '\',\'local\',\'' + escHtml(selected.name) + '\')" title="' + (favActive ? 'Remove from Favourites' : 'Add to Favourites') + '"><svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></button></div><div class="meta">' + authorHtml + '<span><svg viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg>' + cat + '</span></div>' + descHtml + '<div class="actions"><div class="btn-row"><button class="btn" id="runBtn" onclick="run()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M8 5v14l11-7z"/></svg><span id="runBtnText">Run Payload</span></button><button class="btn secondary" id="sourceBtn" onclick="toggleSource()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg><span id="sourceBtnText">View Source</span></button></div>' + deleteRow + '</div>';
            updateRunBtn();
          }
          break;
        }
      }
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    async function refreshPayloads() {
      await load();
    }

    async function downloadLoot() {
      if (!selected || currentResource !== 'loot') return;
      const url = 'cgi-bin/api.sh?action=download_loot&path=' + encodeURIComponent(selected.path);
      window.location.href = url;
    }

    async function downloadAllLoot() {
      window.location.href = 'cgi-bin/api.sh?action=download_loot_all';
    }

    async function deleteLoot() {
      if (!selected || currentResource !== 'loot') return;
      if (!confirm('Delete "' + selected.name + '"?')) return;
      try {
        const resp = await fetch('cgi-bin/api.sh?action=delete_loot&path=' + encodeURIComponent(selected.path));
        const data = await resp.json();
        if (data.success) {
          $('status').textContent = 'Deleted: ' + selected.name;
          selected = null;
          renderDetail();
          refreshPayloads();
        } else {
          $('status').textContent = 'Error: ' + (data.error || 'Delete failed');
        }
      } catch (e) {
        $('status').textContent = 'Error deleting file';
      }
    }

    async function viewLootContent() {
      if (!selected || currentResource !== 'loot') return;
      $('consoleTitle').textContent = 'File: ' + selected.name;
      $('console').innerHTML = '<div class="line">Loading...</div>';
      try {
        const resp = await fetch('cgi-bin/api.sh?action=view_source&path=' + encodeURIComponent(selected.path));
        const text = await resp.text();
        if (resp.ok) {
          $('console').innerHTML = '<pre style="margin:0;white-space:pre-wrap;word-break:break-all">' + escHtml(text) + '</pre>';
        } else {
          $('console').innerHTML = '<div class="line red">Error loading file</div>';
        }
      } catch (e) {
        $('console').innerHTML = '<div class="line red">Error: ' + escHtml(e.message) + '</div>';
      }
    }

    function hideSource() {
      if (!viewingSource) return;
      viewingSource = false;
      $('sourceViewer').style.display = 'none';
      $('console').style.display = '';
      $('consoleTitle').textContent = 'Nautilus Console';
      const btn = $('sourceBtnText');
      if (btn) btn.textContent = 'View Source';
      const prBtn = $('prSourceBtnText');
      if (prBtn) prBtn.textContent = 'View Source';
    }

    function highlightSh(code) {
      const tokens = [];
      let tokenId = 0;
      const placeholder = (type, content) => {
        const id = '\x00T' + tokenId++ + '\x00';
        tokens.push({ id, html: '<span class="sh-' + type + '">' + content + '</span>' });
        return id;
      };
      let result = code
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      result = result.replace(/(#[^\n]*)/g, (m, p1) => placeholder('comment', p1));
      result = result.replace(/("(?:[^"\\]|\\.)*"|'[^']*')/g, (m, p1) => placeholder('string', p1));
      result = result.replace(/\b(if|then|else|elif|fi|for|while|do|done|case|esac|function|return|exit|local|export|source|in)\b/g, (m, p1) => placeholder('keyword', p1));
      result = result.replace(/(\$\{?[A-Za-z_][A-Za-z0-9_]*\}?)/g, (m, p1) => placeholder('variable', p1));
      result = result.replace(/^(\s*)([A-Za-z_][A-Za-z0-9_]*)\s*\(\)/gm, (m, p1, p2) => p1 + placeholder('function', p2) + '()');
      tokens.forEach(t => { result = result.replace(t.id, t.html); });
      return result;
    }

    async function toggleSource() {
      if (!selected) return;

      if (viewingSource) {
        hideSource();
        return;
      }

      let sourcePath = null;
      let isRemote = false;
      let remoteUrl = null;

      if (selected.isGithub) {
        isRemote = true;
        remoteUrl = selected.rawUrl;
      } else if (selected.path) {
        sourcePath = selected.path;
        // Ensure full file path for local resources
        if (currentResource === 'themes' && !sourcePath.endsWith('/theme.json')) {
          sourcePath = sourcePath + '/theme.json';
        } else if (currentResource !== 'ringtones' && !sourcePath.endsWith('/payload.sh') && !sourcePath.endsWith('.rtttl')) {
          sourcePath = sourcePath + '/payload.sh';
        }
      } else {
        return;
      }

      $('consoleTitle').textContent = 'Loading source...';

      try {
        let content = '';
        if (isRemote && remoteUrl) {
          const resp = await fetch(remoteUrl);
          if (!resp.ok) throw new Error('Failed to fetch from GitHub');
          content = await resp.text();
        } else {
          const resp = await fetch('/cgi-bin/api.sh?action=view_source&path=' + encodeURIComponent(sourcePath));
          const data = await resp.json();
          if (data.error) throw new Error(data.error);
          content = data.content.replace(/\\n/g, '\n').replace(/\\t/g, '\t').replace(/\\"/g, '"').replace(/\\\\/g, '\\');
        }

        const lines = content.split('\n');
        let html = '<table>';
        for (let i = 0; i < lines.length; i++) {
          const lineNum = i + 1;
          const highlighted = highlightSh(lines[i]);
          html += '<tr><td class="line-num">' + lineNum + '</td><td class="line-code">' + highlighted + '</td></tr>';
        }
        html += '</table>';

        $('sourceViewer').innerHTML = html;
        $('sourceViewer').style.display = '';
        $('console').style.display = 'none';
        $('consoleTitle').textContent = 'Source: ' + (selected.name || selected.title || 'payload.sh');
        viewingSource = true;

        const btn = $('sourceBtnText');
        if (btn) btn.textContent = 'Hide Source';
      } catch (e) {
        $('consoleTitle').textContent = 'Nautilus Console';
        const line = document.createElement('div');
        line.className = 'line red';
        line.textContent = '[Source] Error: ' + e.message;
        $('console').appendChild(line);
        lineCount++;
        $('lineCount').textContent = lineCount + ' lines';
      }
    }

    async function deletePayload() {
      if (!selected || !selected.path) return;
      if (selected.path.includes('/remote_access/nautilus/')) return;

      $('modalTitle').textContent = 'Delete Payload?';
      $('modalMessage').innerHTML = 'Are you sure you want to <strong>permanently delete</strong> this payload?<br><br><code>' + escHtml(selected.name) + '</code><br><br>This cannot be undone.';
      $('modalInput').style.display = 'none';
      $('modalConfirm').textContent = 'Yes, Delete';
      $('modalCancel').textContent = 'Cancel';
      $('modalCancel').style.display = '';
      $('modalTitle').style.color = '#ff6b6b';
      $('modalOverlay').classList.add('show');

      $('modalConfirm').onclick = async () => {
        $('modalOverlay').classList.remove('show');
        $('modalConfirm').onclick = () => respondPrompt(true);
        $('modalCancel').onclick = () => respondPrompt(false);

        try {
          const resp = await fetch('/cgi-bin/api.sh?action=delete_payload&path=' + encodeURIComponent(selected.path));
          const data = await resp.json();
          if (data.error) {
            const line = document.createElement('div');
            line.className = 'line red';
            line.textContent = '[Delete] Error: ' + data.error;
            $('console').appendChild(line);
          } else {
            const line = document.createElement('div');
            line.className = 'line green';
            line.textContent = '[Delete] Payload deleted successfully';
            $('console').appendChild(line);
            lineCount++;
            $('lineCount').textContent = lineCount + ' lines';
            await refreshPayloads();
            $('detail').innerHTML = '<div class="empty">Select a payload</div>';
            selected = null;
          }
        } catch (e) {
          const line = document.createElement('div');
          line.className = 'line red';
          line.textContent = '[Delete] Failed: ' + e.message;
          $('console').appendChild(line);
        }
      };
      $('modalCancel').onclick = () => {
        $('modalOverlay').classList.remove('show');
        $('modalCancel').onclick = () => respondPrompt(false);
      };
    }

    async function run() {
      if (!selected) return;
      if (running) { stop(); return; }
      hideSource();
      running = true; runningSection = 'local'; lineCount = 0;
      updateRunBtn();
      $('console').innerHTML = '';
      $('lineCount').textContent = '0 lines';
      $('status').textContent = 'Running...';
      $('status').classList.add('running');

      let token = '';
      try {
        const tokenResp = await fetch('/cgi-bin/api.sh?action=token');
        const tokenData = await tokenResp.json();
        if (tokenData.code === 'AUTH_REQUIRED') {
          running = false; runningSection = null; updateRunBtn();
          $('status').textContent = 'Session expired'; $('status').classList.remove('running');
          showLogin(); return;
        }
        token = tokenData.token || '';
      } catch (e) {
        console.error('Failed to get CSRF token:', e);
        $('status').textContent = 'Security error: Could not get token';
        running = false;
        updateRunBtn();
        return;
      }

      evtSource = new EventSource(`/cgi-bin/api.sh?action=run&path=${encodeURIComponent(selected.path)}&token=${encodeURIComponent(token)}`);
      evtSource.onmessage = e => {
        try {
          const d = JSON.parse(e.data);
          const text = d.text.replace(/\\n/g, '\n').replace(/\\\\n/g, '\n');
          const lines = text.split('\n');
          lines.forEach(t => {
            if (t.trim() === '') return;
            const line = document.createElement('div');
            line.className = 'line ' + (d.color || '');
            line.textContent = t;
            $('console').appendChild(line);
            lineCount++;
          });
          $('console').scrollTop = $('console').scrollHeight;
          $('lineCount').textContent = lineCount + ' lines';
        } catch (err) { }
      };
      evtSource.addEventListener('prompt', e => {
        try {
          const d = JSON.parse(e.data);
          showPrompt(d.type, d.message, d.default || '');
        } catch (err) { }
      });
      evtSource.addEventListener('spinner', e => {
        try { const d = JSON.parse(e.data); handleSpinner(d); } catch (err) { }
      });
      evtSource.addEventListener('button_wait', e => {
        try { const d = JSON.parse(e.data); handleButtonWait(d); } catch (err) { }
      });
      evtSource.onerror = () => { stop(false); hideButtonPanel(); };
      evtSource.addEventListener('done', () => { stop(false); hideButtonPanel(); });
    }

    function handleSpinner(data) {
      if (data.action === 'start') {
        activeSpinners[data.id || 'default'] = data.message;
        $('spinnerText').textContent = data.message || 'Loading...';
        $('spinnerOverlay').classList.add('show');
      } else if (data.action === 'stop') {
        delete activeSpinners[data.id || 'default'];
        if (Object.keys(activeSpinners).length === 0) {
          $('spinnerOverlay').classList.remove('show');
        } else {
          const remaining = Object.values(activeSpinners)[0];
          $('spinnerText').textContent = remaining || 'Loading...';
        }
      }
    }

    function hideSpinner() {
      activeSpinners = {};
      $('spinnerOverlay').classList.remove('show');
    }

    let waitingForButton = false;
    let expectedButton = 'ANY';

    function showButtonPanel(expected) {
      waitingForButton = true;
      expectedButton = expected || 'ANY';
      $('buttonPanel').classList.add('show');
      $('expectedButton').textContent = expected === 'ANY' ? 'any' : expected;
      const line = document.createElement('div');
      line.className = 'line cyan';
      line.textContent = '[>] Waiting for button: ' + (expected === 'ANY' ? 'any' : expected);
      $('console').appendChild(line);
      $('console').scrollTop = $('console').scrollHeight;
    }

    function hideButtonPanel() {
      waitingForButton = false;
      $('buttonPanel').classList.remove('show');
    }

    function isButtonAllowed(btn) {
      if (expectedButton === 'ANY') return true;
      const allowed = expectedButton.split(' ').map(s => s.trim().toUpperCase());
      return allowed.includes(btn.toUpperCase());
    }

    async function sendButton(btn) {
      if (!waitingForButton) return;
      if (!isButtonAllowed(btn)) return;
      hideButtonPanel();
      const line = document.createElement('div');
      line.className = 'line green';
      line.textContent = '[v] Button pressed: ' + btn;
      $('console').appendChild(line);
      $('console').scrollTop = $('console').scrollHeight;
      await fetch('/cgi-bin/api.sh?action=respond&response=' + encodeURIComponent(btn)).catch(() => { });
    }

    function handleButtonWait(data) {
      showButtonPanel(data.expected);
      updateButtonStates();
    }

    function updateButtonStates() {
      const btns = document.querySelectorAll('.button-panel .dpad-btn:not(.center),.button-panel .ab-btn');
      btns.forEach(b => {
        const btnName = b.title;
        if (isButtonAllowed(btnName)) {
          b.style.opacity = '1';
          b.style.pointerEvents = 'auto';
        } else {
          b.style.opacity = '0.3';
          b.style.pointerEvents = 'none';
        }
      });
    }

    function updateRunBtn() {
      const btn = $('runBtn');
      const txt = $('runBtnText');
      if (!btn) return;
      const svg = btn.querySelector('svg path');
      if (running) {
        if (svg) svg.setAttribute('d', 'M6 6h12v12H6z');
        if (txt) txt.textContent = 'Stop';
        btn.classList.add('stop');
      } else {
        if (svg) svg.setAttribute('d', 'M8 5v14l11-7z');
        let label = 'Run Payload';
        if (currentResource === 'ringtones') {
          label = selected && selected.isGithub ? 'Play from GitHub' : 'Play Ringtone';
        } else if (selected && selected.isGithub) {
          label = 'Run from GitHub';
        }
        if (txt) txt.textContent = label;
        btn.classList.remove('stop');
      }
    }

    function stop(hardStop = true) {
      const wasRunning = running;
      const wasInstalling = installing;
      if (evtSource) { evtSource.close(); evtSource = null; }
      if (installEvtSource) { installEvtSource.close(); installEvtSource = null; }
      running = false;
      installing = false;
      pendingPRInstall = null;
      runningSection = null;
      hideSpinner();
      hideButtonPanel();
      updateRunBtn();
      updateInstallBtn();
      updateInstallPRBtn();
      $('status').textContent = 'Ready  ' + Object.values(payloads).flat().length + ' payloads';
      $('status').classList.remove('running');
      fetch('/cgi-bin/api.sh?action=stop').catch(() => { });
      if (wasRunning && hardStop) {
        const line = document.createElement('div');
        line.className = 'line red';
        line.textContent = 'Payload hard-stopped';
        $('console').appendChild(line);
        lineCount++;
        $('lineCount').textContent = lineCount + ' lines';
        $('console').scrollTop = $('console').scrollHeight;
      }
      if (wasInstalling && hardStop) {
        const line = document.createElement('div');
        line.className = 'line red';
        line.textContent = '[Install] Cancelled - partial files cleaned up';
        $('console').appendChild(line);
        lineCount++;
        $('lineCount').textContent = lineCount + ' lines';
        $('console').scrollTop = $('console').scrollHeight;
      }
    }

    function clearConsole() {
      $('console').innerHTML = '';
      lineCount = 0;
      $('lineCount').textContent = '0 lines';
    }

    let currentPromptType = 'confirm';
    let currentPromptDefault = '';
    const promptTitles = { confirm: 'Confirm', text: 'Enter Text', number: 'Enter Number', ip: 'Enter IP Address', mac: 'Enter MAC Address', alert: 'Alert', error: 'Error', prompt: '' };
    const promptPatterns = {
      ip: /^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,
      mac: /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/
    };
    const promptPlaceholders = { text: 'Enter text...', number: '0', ip: '192.168.1.1', mac: '00:11:22:33:44:55' };

    function showPrompt(type, message, defaultVal) {
      currentPromptType = type;
      currentPromptDefault = defaultVal || '';
      $('modalTitle').textContent = type in promptTitles ? promptTitles[type] : 'Input';
      const msgHtml = escHtml(message.replace(/\\n/g, '\n')).replace(/\n/g, '<br>');
      $('modalMessage').innerHTML = msgHtml;
      const inp = $('modalInput');
      const confirmBtn = $('modalConfirm');
      const cancelBtn = $('modalCancel');

      if (type === 'alert' || type === 'error' || type === 'prompt') {
        inp.style.display = 'none';
        confirmBtn.textContent = 'OK';
        cancelBtn.style.display = 'none';
        $('modalTitle').style.color = type === 'error' ? '#ff6b6b' : type === 'alert' ? '#ffd93d' : '';
      } else if (type === 'confirm') {
        inp.style.display = 'none';
        confirmBtn.textContent = 'Yes';
        cancelBtn.textContent = 'No';
        cancelBtn.style.display = '';
        $('modalTitle').style.color = '';
      } else {
        inp.style.display = 'block';
        inp.type = type === 'number' ? 'number' : 'text';
        inp.placeholder = promptPlaceholders[type] || '';
        inp.value = currentPromptDefault;
        confirmBtn.textContent = 'Submit';
        cancelBtn.style.display = 'none';
        $('modalTitle').style.color = '';
        inp.oninput = () => validatePromptInput();
        setTimeout(() => { inp.focus(); inp.select(); }, 100);
      }
      $('modalOverlay').classList.add('show');
      validatePromptInput();
      const line = document.createElement('div');
      line.className = 'line ' + (type === 'error' ? 'red' : type === 'alert' ? 'yellow' : 'cyan');
      line.textContent = (type === 'error' ? '[X] ' : type === 'alert' ? '[!] ' : '[?] ') + message + (currentPromptDefault ? ' (default: ' + currentPromptDefault + ')' : '');
      $('console').appendChild(line);
      $('console').scrollTop = $('console').scrollHeight;
    }

    function validatePromptInput() {
      const inp = $('modalInput');
      const btn = $('modalConfirm');
      const val = inp.value.trim();
      let valid = true;

      if (currentPromptType === 'number') {
        valid = val === '' || !isNaN(parseFloat(val));
      } else if (currentPromptType === 'ip') {
        valid = promptPatterns.ip.test(val);
      } else if (currentPromptType === 'mac') {
        valid = promptPatterns.mac.test(val);
      }

      btn.disabled = !valid && currentPromptType !== 'confirm' && currentPromptType !== 'text';
      inp.style.borderColor = valid ? 'var(--border)' : '#e74c3c';
    }

    async function respondPrompt(confirmed) {
      const inp = $('modalInput');
      let response = '';

      if (currentPromptType === 'confirm' || currentPromptType === 'prompt') {
        response = '1';
      } else if (!confirmed) {
        response = currentPromptDefault;
      } else {
        response = inp.value.trim() || currentPromptDefault;
        if (currentPromptType === 'ip' && !promptPatterns.ip.test(response)) {
          inp.style.borderColor = '#e74c3c';
          inp.focus();
          return;
        }
        if (currentPromptType === 'mac' && !promptPatterns.mac.test(response)) {
          inp.style.borderColor = '#e74c3c';
          inp.focus();
          return;
        }
        if (currentPromptType === 'number') {
          response = parseFloat(response) || 0;
        }
      }

      $('modalOverlay').classList.remove('show');
      const line = document.createElement('div');
      line.className = 'line ' + (confirmed ? 'green' : 'yellow');
      line.textContent = '[v] ' + (currentPromptType === 'confirm' ? (confirmed ? 'Yes' : 'No') : currentPromptType === 'prompt' ? 'OK' : response);
      $('console').appendChild(line);
      $('console').scrollTop = $('console').scrollHeight;
      await fetch('/cgi-bin/api.sh?action=respond&response=' + encodeURIComponent(response)).catch(() => { });
    }

    let nautilusConfig = { autoMode: false, runMode: 'foreground' };

    function openSettings() {
      $('settingsModal').classList.add('show');
      loadSettings();
    }

    function closeSettings() {
      $('settingsModal').classList.remove('show');
    }

    async function loadSettings() {
      $('settingsLoading').style.display = 'flex';
      $('settingsContent').style.display = 'none';
      try {
        const resp = await fetch('/cgi-bin/api.sh?action=get_config&key=auto_mode');
        const data = await resp.json();
        nautilusConfig.autoMode = data.value === 'true';
        $('toggleAutoMode').classList.toggle('on', nautilusConfig.autoMode);
        $('autoModeBody').classList.toggle('disabled', !nautilusConfig.autoMode);
      } catch (e) { }
      try {
        const resp = await fetch('/cgi-bin/api.sh?action=get_config&key=run_mode');
        const data = await resp.json();
        if (data.value) nautilusConfig.runMode = data.value;
        $('selectRunMode').value = nautilusConfig.runMode;
      } catch (e) { }
      $('settingsLoading').style.display = 'none';
      $('settingsContent').style.display = 'block';
    }

    async function toggleAutoMode() {
      const toggle = $('toggleAutoMode');
      const newVal = !toggle.classList.contains('on');
      toggle.classList.toggle('on', newVal);
      $('autoModeBody').classList.toggle('disabled', !newVal);
      nautilusConfig.autoMode = newVal;
      showSettingsStatus('saving', 'Saving...');
      try {
        await fetch('/cgi-bin/api.sh?action=set_config&key=auto_mode&value=' + (newVal ? 'true' : 'false'));
        showSettingsStatus('saved', 'Saved');
      } catch (e) {
        showSettingsStatus('error', 'Failed to save');
      }
    }

    async function setRunMode(val) {
      nautilusConfig.runMode = val;
      showSettingsStatus('saving', 'Saving...');
      try {
        await fetch('/cgi-bin/api.sh?action=set_config&key=run_mode&value=' + encodeURIComponent(val));
        showSettingsStatus('saved', 'Saved');
      } catch (e) {
        showSettingsStatus('error', 'Failed to save');
      }
    }

    function showSettingsStatus(type, msg) {
      const el = $('settingsStatus');
      el.className = 'settings-status ' + type;
      el.textContent = msg;
      if (type === 'saved') setTimeout(() => { el.textContent = ''; el.className = 'settings-status'; }, 2000);
    }

    // Resizable panels
    function initResize() {
      const sidebar = document.querySelector('.sidebar');
      const mainLeft = document.querySelector('.main-left');
      const consolePanel = document.querySelector('.console-panel');

      function setupResize(handle, target, minSize, maxSize, direction = 'width') {
        if (!handle || !target) return;
        let startPos, startSize;

        function onMouseDown(e) {
          e.preventDefault();
          startPos = direction === 'width' ? e.clientX : e.clientY;
          startSize = direction === 'width' ? target.offsetWidth : target.offsetHeight;
          handle.classList.add('dragging');
          document.body.classList.add(direction === 'width' ? 'resizing' : 'resizing-v');
          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        }

        function onMouseMove(e) {
          const delta = (direction === 'width' ? e.clientX : e.clientY) - startPos;
          let newSize = startSize + delta;
          if (minSize) newSize = Math.max(minSize, newSize);
          if (maxSize) newSize = Math.min(maxSize, newSize);
          target.style[direction] = newSize + 'px';
          if (shellFitAddon) shellFitAddon.fit();
        }

        function onMouseUp() {
          handle.classList.remove('dragging');
          document.body.classList.remove('resizing', 'resizing-v');
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
          localStorage.setItem('nautilus_' + target.className.split(' ')[0] + '_size', target.style[direction]);
        }

        handle.addEventListener('mousedown', onMouseDown);
        const saved = localStorage.getItem('nautilus_' + target.className.split(' ')[0] + '_size');
        if (saved) target.style[direction] = saved;
      }

      setupResize($('resizeSidebar'), sidebar, 200, 500, 'width');
      setupResize($('resizeDetail'), mainLeft, 250, 600, 'width');
      setupResize($('resizeConsole'), consolePanel, 200, window.innerWidth * 0.6, 'width');

      // Initialize console panel with pixel width if using percentage
      if (consolePanel && !consolePanel.style.width.includes('px')) {
        consolePanel.style.width = consolePanel.offsetWidth + 'px';
      }

      // Pager height resize
      const pagerContainer = $('pager-container');
      if (pagerContainer) {
        setupResize($('resizePager'), pagerContainer, 100, 600, 'height');
      }
    }

    /* Virtual Pager Logic */
    let keyws, screenws;
    const SCREEN_WIDTH = 480;
    const SCREEN_HEIGHT = 222;
    const FB_STRIDE = SCREEN_WIDTH * 4;
    let loggedFrameInfo = false;

    function renderRGBAFrame(bytes) {
      const pager = document.getElementById('pager');
      const canvas = document.getElementById("pager_canvas");
      if (!pager || !canvas) return;
      const ctx = canvas.getContext("2d");

      if (!loggedFrameInfo) {
        console.log("frameInfo", {
          byteLength: bytes.length,
          expectedBytesMin: FB_STRIDE * SCREEN_HEIGHT,
          SCREEN_WIDTH,
          SCREEN_HEIGHT,
          FB_STRIDE
        });
        loggedFrameInfo = true;
      }

      if (bytes.length < FB_STRIDE * SCREEN_HEIGHT) {
        console.warn("Frame too small for configured stride/size");
        return;
      }

      const imageData = ctx.createImageData(SCREEN_WIDTH, SCREEN_HEIGHT);
      const dst = imageData.data; // RGBA

      let di = 0;
      for (let y = 0; y < SCREEN_HEIGHT; y++) {
        const rowStart = y * FB_STRIDE;
        for (let x = 0; x < SCREEN_WIDTH; x++) {
          const si = rowStart + x * 4; // 4 bytes per pixel: R,G,B,A
          dst[di] = bytes[si]; // R
          dst[di + 1] = bytes[si + 1]; // G
          dst[di + 2] = bytes[si + 2]; // B
          dst[di + 3] = bytes[si + 3]; // A
          di += 4;
        }
      }

      ctx.putImageData(imageData, 0, 0);
      pager.src = canvas.toDataURL("image/png");
    }

    function connectPager() {
      const pager = document.getElementById('pager');
      const pagererr = document.getElementById('pager_error');
      if (!pager) return;

      try {
        if (keyws) keyws.close();
        // Nautilus runs on port 8888, connecting to local proxy on 8890 which forwards to 1471
        const targetHost = window.location.hostname;
        const targetPort = '8890';
        console.log(`Connecting Pager to Proxy at ${targetHost}:${targetPort}`);

        keyws = new WebSocket(`ws://${targetHost}:${targetPort}/api/pager/input/keys.ws`);
      } catch (e) { console.error("Pager KeyWS error", e); }

      try {
        if (screenws) screenws.close();
        const targetHost = window.location.hostname;
        const targetPort = '8890';
        screenws = new WebSocket(`ws://${targetHost}:${targetPort}/api/pager/display/screen.ws`);
        screenws.binaryType = "arraybuffer";

        screenws.onopen = () => {
          if (pager) pager.style.display = 'block';
          if (pagererr) pagererr.style.display = 'none';
          $('pager-container').style.display = 'flex';
        }

        screenws.onmessage = (event) => {
          if (!pager) return;
          const buffer = event.data;
          const bytes = new Uint8Array(buffer);
          renderRGBAFrame(bytes);
        };

        screenws.onerror = (err) => {
          console.error("Pager WS Error:", err);
          if (pager) pager.style.display = 'none';
          if (pagererr) {
            pagererr.style.display = 'flex';
            pagererr.innerHTML = `Lost connection to virtual pager<br><small>WS Error (Check Console)</small><br><button onclick="connectPager()">Reconnect</button>`;
          }
        }

        screenws.onclose = (evt) => {
          console.log("Pager WS Closed:", evt);
          if (pager) pager.style.display = 'none';
          if (pagererr) {
            pagererr.style.display = 'flex';
            pagererr.innerHTML = `Lost connection to virtual pager<br><small>Code: ${evt.code}, Reason: ${evt.reason || 'None'}</small><br><button onclick="connectPager()">Reconnect</button>`;
          }
        }
      } catch (e) { console.error("Pager ScreenWS error", e); }
    }

    function togglePager() {
      const c = $('pager-container');
      if (!c) return;
      if (c.style.display === 'none' || c.style.display === '') {
        c.style.display = 'flex';
        connectPager();
      } else {
        c.style.display = 'none';
        if (screenws) screenws.close();
        if (keyws) keyws.close();
      }
    }

    let pagerResizeObs = null;

    function initPagerResize() {
      const container = document.getElementById('pager-container');
      const wrapper = document.getElementById('pagerScaleWrapper');
      const PAGER_WIDTH = 745;
      const PAGER_HEIGHT = 531;

      if (!container || !wrapper) return;

      if (pagerResizeObs) pagerResizeObs.disconnect();

      pagerResizeObs = new ResizeObserver(entries => {
        for (let entry of entries) {
          const width = entry.contentRect.width;
          const height = entry.contentRect.height;
          if (width === 0 || height === 0) continue; // hidden

          // Calculate scale based on both width and height
          const availableWidth = width - 20;
          const availableHeight = height - 20;

          const scaleW = availableWidth < PAGER_WIDTH ? availableWidth / PAGER_WIDTH : 1;
          const scaleH = availableHeight < PAGER_HEIGHT ? availableHeight / PAGER_HEIGHT : 1;
          const scale = Math.min(scaleW, scaleH);

          // Apply scale
          wrapper.style.transform = `scale(${scale})`;
          wrapper.style.transformOrigin = 'top center';

          // Adjust wrapper dimensions to match scaled size
          wrapper.style.width = `${PAGER_WIDTH}px`;
          wrapper.style.height = `${PAGER_HEIGHT * scale}px`;
        }
      });

      pagerResizeObs.observe(container);
    }

    initResize();
    initPagerResize();
    initAuth();
    initShell();
  </script>
</body>

</html>

</html>